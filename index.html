<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CRM PROXI</title>
  <style>
    :root {
      --bg: #1c1917;
      --card: #111827;
      --card-soft: #0f172a;
      --accent: #f97316;
      --accent-soft: rgba(248, 148, 56, 0.18);
      --text: #f9fafb;
      --muted: #e5e7eb;
      --border: #374151;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, 'SF Pro Text', sans-serif;
      background:
        radial-gradient(circle at top left, rgba(248, 148, 56, 0.35), transparent 55%),
        radial-gradient(circle at bottom right, rgba(34,197,94,0.22), transparent 55%),
        linear-gradient(145deg, #0b1120, #111827);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      align-items: stretch;
      justify-content: center;
    }
    .app-shell {
      width: 100%;
      max-width: 1400px;
      display: flex;
      gap: 16px;
      padding: 16px;
    }
    .card {
      background: linear-gradient(145deg, rgba(15,23,42,0.96), rgba(15,23,42,0.9));
      border-radius: 18px;
      padding: 18px 20px;
      border: 1px solid rgba(249,250,251,0.08);
      box-shadow: 0 18px 50px rgba(15,23,42,0.9);
    }
    .sidebar { width: 260px; display: flex; flex-direction: column; gap: 12px; }
    .main { flex: 1; display: flex; flex-direction: column; gap: 16px; }
    h1 {
      margin: 0 0 4px;
      font-size: 22px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .logo-dot {
      width: 9px; height: 9px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 20%, #fed7aa, #f97316);
      box-shadow: 0 0 18px rgba(248,148,56,0.9);
    }
    .subtext { font-size: 13px; color: var(--muted); opacity: .85; }
    .login-card { width: 100%; max-width: 420px; margin: auto; }
    .field { margin-bottom: 12px; }
    label { display: block; margin-bottom: 4px; font-size: 13px; color: var(--muted); opacity: .9; }
    select, input, textarea {
      width: 100%;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: rgba(15,23,42,0.9);
      color: var(--text);
      font-size: 13px;
      resize: vertical;
    }
    select:focus, input:focus, textarea:focus {
      outline: 1px solid var(--accent);
      border-color: var(--accent);
    }
    button {
      border: none;
      border-radius: 999px;
      padding: 8px 16px;
      background: radial-gradient(circle at 30% 0, #fed7aa, #f97316);
      color: #1c1917;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      box-shadow: 0 12px 30px rgba(248,148,56,0.55);
    }
    button.secondary {
      background: transparent;
      color: var(--muted);
      box-shadow: none;
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 12px;
    }
    .commercial-row {
      padding: 8px 10px;
      border-radius: 10px;
      margin-bottom: 6px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: rgba(15,23,42,0.88);
      border: 1px solid transparent;
    }
    .commercial-row.active { border-color: var(--accent); background: rgba(248,148,56,0.14); }
    .commercial-row:hover { border-color: rgba(249,250,251,0.32); }
    .commercial-name { font-size: 14px; }
    .commercial-meta { font-size: 11px; color: var(--muted); opacity: .8; }
    .list { margin-top: 10px; max-height: calc(100vh - 230px); overflow: auto; }

    .kpi-row {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 10px;
      margin-top: 10px;
    }
    .kpi-card {
      padding: 10px 12px;
      border-radius: 14px;
      background: radial-gradient(circle at 0 0, rgba(248,148,56,0.16), rgba(15,23,42,0.98));
      border: 1px solid rgba(249,250,251,0.14);
      font-size: 12px;
    }
    .kpi-label { color: var(--muted); font-size: 11px; opacity:.9; }
    .kpi-value { font-size: 17px; font-weight: 600; margin-top: 3px; }

    .tabs {
      display: inline-flex;
      padding: 3px;
      border-radius: 999px;
      background: rgba(15,23,42,0.95);
      border: 1px solid rgba(249,250,251,0.2);
    }
    .tab-btn {
      border-radius: 999px;
      padding: 6px 14px;
      font-size: 12px;
      border: none;
      background: transparent;
      color: var(--muted);
      cursor: pointer;
    }
    .tab-btn.active {
      background: rgba(248,148,56,0.9);
      color: #1c1917;
    }

    table { width: 100%; border-collapse: collapse; font-size: 12px; margin-top: 8px; }
    th, td {
      padding: 6px 8px;
      border-bottom: 1px solid rgba(31,41,55,0.9);
      text-align: left;
      vertical-align: top;
    }
    th { font-size: 11px; color: var(--muted); text-transform: uppercase; letter-spacing: .06em; opacity:.8; }
    tr:hover td { background: rgba(15,23,42,0.9); cursor: pointer; }

    .two-columns {
      display: grid;
      grid-template-columns: minmax(0, 1.2fr) minmax(0, 1fr);
      gap: 12px;
      margin-top: 10px;
      align-items: flex-start;
    }

    @media (max-width: 900px) {
      .app-shell { flex-direction: column; }
      .sidebar { width: 100%; }
      .two-columns { grid-template-columns: minmax(0,1fr); }
      .kpi-row { grid-template-columns: repeat(2,minmax(0,1fr)); }
    }
  </style>
</head>

<body>
  <div id="root" style="width:100%"></div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    const SUPABASE_URL = "https://sytpnqayyyjdjhojafyi.supabase.co";
    const SUPABASE_KEY = "sb_publishable_5ernJ3tbCW3XnAdx983E8A_ASPSKBVx";
    const { createClient } = supabase;
    const sb = createClient(SUPABASE_URL, SUPABASE_KEY);

    const USERS = {
      admins: [
        { id: "admin-marie-charlotte", name: "Marie-Charlotte", role: "admin" },
        { id: "admin-xavier", name: "Xavier", role: "admin" }
      ],
      commerciaux: [
        { id: "costanza-damien", name: "COSTANZA Damien" },
        { id: "besquent-dominique", name: "BESQUENT Dominique" },
        { id: "hamparsoumiam-armand", name: "HAMPARSOUMIAN Armand" },
        { id: "juif-olivier", name: "JUIF Olivier" },
        { id: "laurent-severine", name: "LAURENT S√©verine" },
        { id: "michelet-yves", name: "MICHELET Yves" },
        { id: "aydogan-nevin", name: "AYDOGAN Nevin" },
        { id: "vernay-benoit", name: "VERNAY Benoit" }
      ]
    };

    const STORES = [
      { id:"montpellier-delicie", name:"Montpellier Delicie", ca2024:503033, commercialId:"costanza-damien" },
      { id:"moussac", name:"Moussac", ca2024:378503, commercialId:"costanza-damien" },
      { id:"saint-jean-du-gard", name:"Saint Jean du Gard", ca2024:361924, commercialId:"costanza-damien" },
      { id:"lus-la-croix-haute", name:"Lus La Croix Haute", ca2024:308362, commercialId:"costanza-damien" },
      { id:"poulx-chenes", name:"Poulx Ch√™nes", ca2024:308221, commercialId:"costanza-damien" },
      { id:"valras-plage", name:"Valras-Plage", ca2024:172560, commercialId:"costanza-damien" },
      { id:"charols", name:"Charols", ca2024:162242, commercialId:"costanza-damien" },
      { id:"vercheny", name:"Vercheny", ca2024:156344, commercialId:"costanza-damien" },
      { id:"st-ambroix", name:"Saint ambroix", ca2024:154212, commercialId:"costanza-damien" },
      { id:"bouillargues", name:"Bouillargues", ca2024:99687, commercialId:"costanza-damien" },
      { id:"colmars-les-alpes", name:"Colmars les Alpes", ca2024:799900, commercialId:"besquent-dominique" },
      { id:"bargemon", name:"Bargemon", ca2024:719952, commercialId:"besquent-dominique" },
      { id:"la-palud-verdon", name:"La Palud s/Verdon", ca2024:505004, commercialId:"besquent-dominique" },
      { id:"moutiers-eglise", name:"Moutiers √âglise", ca2024:350261, commercialId:"besquent-dominique" },
      { id:"callas", name:"Callas", ca2024:343055, commercialId:"besquent-dominique" },
      { id:"frejus-anc-comb-afn", name:"Fr√©jus Anc Comb AFN", ca2024:336117, commercialId:"besquent-dominique" },
      { id:"comps-artuby", name:"Comps s/Artuby", ca2024:317976, commercialId:"besquent-dominique" },
      { id:"les-salles-verdon", name:"Les Salles sur Verdon", ca2024:316500, commercialId:"besquent-dominique" },
      { id:"greoux-les-bains", name:"Gr√©oux-les-Bains", ca2024:305397, commercialId:"besquent-dominique" },
      { id:"frejus-afrique-n3775", name:"Fr√©jus Afrique N3775", ca2024:291165, commercialId:"besquent-dominique" },
      { id:"apt-marchand", name:"Apt Marchand", ca2024:558971, commercialId:"hamparsoumiam-armand" },
      { id:"calacussia", name:"Calacussia", ca2024:519365, commercialId:"hamparsoumiam-armand" },
      { id:"savines-le-lac", name:"Savines le Lac", ca2024:344729, commercialId:"hamparsoumiam-armand" },
      { id:"ceillac-rue-ppl", name:"Ceillac Rue PPL", ca2024:332701, commercialId:"hamparsoumiam-armand" },
      { id:"l-ile-rousse", name:"L'√éle Rousse", ca2024:301807, commercialId:"hamparsoumiam-armand" },
      { id:"mirabeau", name:"Mirabeau", ca2024:298647, commercialId:"hamparsoumiam-armand" },
      { id:"orcieres-merlette", name:"Orci√®res Merlette", ca2024:298214, commercialId:"hamparsoumiam-armand" },
      { id:"ajaccio-napoleon", name:"Ajaccio Napol√©on", ca2024:289735, commercialId:"hamparsoumiam-armand" },
      { id:"tallard-dumont", name:"Tallard Dumont", ca2024:282726, commercialId:"hamparsoumiam-armand" },
      { id:"vacqueyras", name:"Vacqueyras", ca2024:254074, commercialId:"hamparsoumiam-armand" },
      { id:"guillaumes", name:"Guillaumes", ca2024:584678, commercialId:"juif-olivier" },
      { id:"valdeblore", name:"Valdeblore", ca2024:463999, commercialId:"juif-olivier" },
      { id:"st-etienne-tinee", name:"St √âtienne de Tin√©e", ca2024:444197, commercialId:"juif-olivier" },
      { id:"carces", name:"Carc√®s", ca2024:418646, commercialId:"juif-olivier" },
      { id:"nice-e-dorves", name:"Nice E. d'Orves", ca2024:399883, commercialId:"juif-olivier" },
      { id:"st-julien", name:"St Julien", ca2024:376184, commercialId:"juif-olivier" },
      { id:"antibes-4-chemins", name:"Antibes 4 Chemins", ca2024:300493, commercialId:"juif-olivier" },
      { id:"bormes-mimosas-plage", name:"Bormes les Mimosas Plage", ca2024:290531, commercialId:"juif-olivier" },
      { id:"nice-thiers", name:"Nice Thiers", ca2024:232677, commercialId:"juif-olivier" },
      { id:"peille-virounours", name:"Peille Virounours", ca2024:214091, commercialId:"juif-olivier" },
      { id:"varennes-st-sauveur", name:"Varennes St Sauveur", ca2024:329427, commercialId:"laurent-severine" },
      { id:"belmont-loire", name:"Belmont de la Loire", ca2024:239901, commercialId:"laurent-severine" },
      { id:"cunlhat-domaize", name:"Cunlhat Domaize", ca2024:227290, commercialId:"laurent-severine" },
      { id:"branges-bourg", name:"Branges Bourg", ca2024:203375, commercialId:"laurent-severine" },
      { id:"vernet-la-varenne", name:"Vernet la Varenne", ca2024:198285, commercialId:"laurent-severine" },
      { id:"st-julien-la-vetre", name:"Saint Julien la V√™tre", ca2024:143331, commercialId:"laurent-severine" },
      { id:"issy-l-eveque", name:"Issy l'√âv√™que", ca2024:120262, commercialId:"laurent-severine" },
      { id:"lucenay-l-eveque", name:"Lucenay l'√âv√™que", ca2024:113586, commercialId:"laurent-severine" },
      { id:"vollore-ville", name:"Vollore Ville", ca2024:103120, commercialId:"laurent-severine" },
      { id:"vichy", name:"Vichy", ca2024:95858, commercialId:"laurent-severine" },
      { id:"monsols", name:"Monsols", ca2024:485466, commercialId:"michelet-yves" },
      { id:"propieres", name:"Propi√®res", ca2024:451599, commercialId:"michelet-yves" },
      { id:"bessenay", name:"Bessenay", ca2024:295103, commercialId:"michelet-yves" },
      { id:"legny-tarrets", name:"L√©gny Tarrets", ca2024:219820, commercialId:"michelet-yves" },
      { id:"porte-pier-dor-ecla", name:"Porte Pier Dor √âcla", ca2024:205801, commercialId:"michelet-yves" },
      { id:"montanay-poype", name:"Montanay Poype", ca2024:198797, commercialId:"michelet-yves" },
      { id:"leymant", name:"Leyment", ca2024:182849, commercialId:"michelet-yves" },
      { id:"villeurbanne-blum", name:"Villeurbanne Blum", ca2024:166715, commercialId:"michelet-yves" },
      { id:"nivigne-et-suran", name:"Nivigne et Suran", ca2024:152322, commercialId:"michelet-yves" },
      { id:"lyon-croix-rousse", name:"Lyon Croix Rousse", ca2024:133155, commercialId:"michelet-yves" },
      { id:"virieu-lamartine", name:"Virieu Lamartine", ca2024:655986, commercialId:"aydogan-nevin" },
      { id:"st-sorlin-d-arves", name:"St Sorlin d'Arves", ca2024:574774, commercialId:"aydogan-nevin" },
      { id:"le-bourget-du-lac", name:"Le Bourget du Lac", ca2024:497771, commercialId:"aydogan-nevin" },
      { id:"courchevel", name:"Courchevel", ca2024:407291, commercialId:"aydogan-nevin" },
      { id:"auris-oisans", name:"Auris en Oisans", ca2024:404916, commercialId:"aydogan-nevin" },
      { id:"macot-la-plagne", name:"Macot la Plagne", ca2024:357829, commercialId:"aydogan-nevin" },
      { id:"val-thorens-temple", name:"Val thorens temple", ca2024:280341, commercialId:"aydogan-nevin" },
      { id:"areches", name:"Ar√™ches", ca2024:271143, commercialId:"aydogan-nevin" },
      { id:"monestiers-clermont", name:"Monestiers Clermont", ca2024:231951, commercialId:"aydogan-nevin" },
      { id:"lepin-le-lac", name:"Lepin le lac", ca2024:210577, commercialId:"aydogan-nevin" },
      { id:"vals-les-bains", name:"Vals les Bains", ca2024:553773, commercialId:"vernay-benoit" },
      { id:"langogne-capucins", name:"Langogne Capucins", ca2024:370729, commercialId:"vernay-benoit" },
      { id:"st-mamet-salvetat", name:"St Mamet la Salvetat", ca2024:337355, commercialId:"vernay-benoit" },
      { id:"chadrac-pm", name:"Chadrac PM", ca2024:316194, commercialId:"vernay-benoit" },
      { id:"st-fortunat", name:"St Fortunat", ca2024:311429, commercialId:"vernay-benoit" },
      { id:"espaly-st-marcel", name:"Espaly St Marcel", ca2024:247376, commercialId:"vernay-benoit" },
      { id:"colombier-le-jeune", name:"Colombier le Jeune", ca2024:240298, commercialId:"vernay-benoit" },
      { id:"le-cheylard", name:"Le Cheylard", ca2024:197555, commercialId:"vernay-benoit" },
      { id:"langeac-lafayette", name:"Langeac Lafayette", ca2024:196202, commercialId:"vernay-benoit" },
      { id:"allanche", name:"Allanche", ca2024:168103, commercialId:"vernay-benoit" }
    ];

    const WAVES = [
      { id: "wave1", label: "Vague 1" },
      { id: "wave2", label: "Vague 2" },
      { id: "wave3", label: "Vague 3" },
      { id: "wave4", label: "Vague 4" },
      { id: "wave5", label: "Vague 5" },
      { id: "wave6", label: "Vague 6" }
    ];

    const SEASONS = ["Printemps", "√ât√©", "Automne", "Hiver"];
    const WAVE_STATUSES = ["Non concern√©", "√Ä faire", "En cours", "Engag√©", "Refus√©"];

    const PROMOS = {
  "2026-01": {
    proxi: [
      { id: "beurre-montfleuri-250g", label: "Beurre Montfleuri 250g" },
      { id: "lait-bio-1l", label: "Lait 1L Bio CRF" },
      { id: "oeufs-plein-air-6", label: "≈íufs plein air x6" },
      { id: "steak-hache-18", label: "Steak hach√© (lot 18)" },
      { id: "jambon-paris-160g", label: "Jambon de Paris 160g" },
      { id: "sucre-poudre-1kg", label: "Sucre poudre 1kg" },
      { id: "farine-ble-t55-1kg", label: "Farine bl√© T55 1kg" },
      { id: "nutella-825g", label: "Nutella 825g" },
      { id: "confiture-fraise-370g", label: "Confiture fraise 370g" },
      { id: "coca-1-75l", label: "Coca-Cola 1,75L" },
      { id: "biere-goudale-75cl", label: "Bi√®re Goudale 75cl" },
      { id: "emmental-rape-500g", label: "Emmental r√¢p√© 500g" }
    ],
    proxi_super: [] // volontairement vide ‚Üí m√™me liste
  }
};
    const PROXI_SUPER_STORES = [
  "montpellier-delicie",
  "moussac",
  "saint-jean-du-gard",
  "lus-la-croix-haute",
  "poulx-chenes",
  "bouillargues",
  "la-palud-verdon",
  "moutiers-eglise",
  "frejus-anc-comb-afn",
  "comps-artuby",
  "les-salles-verdon",
  "mirabeau",
  "bormes-mimosas-plage",
  "cunlhat-domaize",
  "propieres",
  "legny-tarrets",
  "val-thorens-temple",
  "le-bourget-du-lac",
  "courchevel",
  "auris-oisans",
  "vals-les-bains",
  "langogne-capucins",
  "st-mamet-salvetat",
  "chadrac-pm",
  "espaly-st-marcel",
  "le-cheylard"
];

function getStoreFormat(store) {
  return PROXI_SUPER_STORES.includes(store.id)
    ? "proxi_super"
    : "proxi";
}

  const FL_OBJECTIFS_2025 = { 
  "saint-jean-du-gard": 43225,
  "lus-la-croix-haute": 37705,
  "moussac": 36587,
  "st-ambroix": 18353,
  "valras-plage": 12126,
  "charols": 11500,
  "vercheny": 807,
  "poulx-chenes": 0,
  "montpellier-delicie": 0,
  "bouillargues": 0,
  "colmars-les-alpes": 128444,
  "bargemon": 97822, 
  "la-palud-verdon": 60676, 
  "moutiers-eglise": 60564,
  "les-salles-verdon": 42004,
  "greoux-les-bains": 29010,
  "comps-artuby": 27510,
  "frejus-anc-comb-afn": 690, 
  "frejus-afrique-n3775": 136,
  "callas": 0,
  "tallard-dumont": 30259,
  "ceillac-rue-ppl": 29028,
  "mirabeau": 24925,
  "savines-le-lac": 19488,
  "l-ile-rousse": 19041,
  "apt-marchand": 6890, 
  "calacussia": 0,
  "orcieres-merlette": 0,
  "ajaccio-napoleon": 0,
  "vacqueyras": 1120,
  "valdeblore": 84018,
  "nice-e-dorves": 69950, 
  "st-etienne-tinee": 69913,
  "st-julien": 62016, 
  "guillaumes": 41890,
  "nice-thiers": 34029,
  "carces": 30340, 
  "peille-virounours": 22148,
  "bormes-mimosas-plage": 3831,
  "antibes-4-chemins": 0,
  "varennes-st-sauveur": 61876,
  "cunlhat-domaize": 30945,
  "issy-l-eveque": 25513,
  "branges-bourg": 23822,
  "belmont-loire": 18275,
  "st-julien-la-vetre": 17599,
  "vernet-la-varenne": 7092,
  "vollore-ville": 2318,
  "lucenay-l-eveque": 0,  
  "vichy": 0,
  "propieres": 55120,
  "monsols": 47550,  
  "bessenay": 37903, 
  "porte-pier-dor-ecla": 26459,
  "montanay-poype": 19640,
  "nivigne-et-suran": 12343,
  "lyon-croix-rousse": 1334,
  "legny-tarrets": 5588,   
  "leymant": 4407, 
  "villeurbanne-blum": 0, 
  "le-bourget-du-lac": 104435,
  "st-sorlin-d-arves": 65475,
  "courchevel": 46871,
  "macot-la-plagne": 37894,
  "areches": 36226,
  "virieu-lamartine": 34027, 
  "monestiers-clermont": 17599,
  "val-thorens-temple": 17354,
  "auris-oisans": 13857, 
  "lepin-le-lac": 13835,
  "st-mamet-salvetat": 45653,
  "langogne-capucins": 19764, 
  "vals-les-bains": 17858,
  "le-cheylard": 2156,
  "allanche": 1582,
  "chadrac-pm": 0, 
  "st-fortunat": 0, 
  "espaly-st-marcel": 0, 
  "colombier-le-jeune": 0,  
  "langeac-lafayette": 0
     
};
      function getFlTarget(storeId) {
      const v = FL_OBJECTIFS_2025[storeId];
      const n = Number(v || 0);
      return Number.isNaN(n) ? 0 : n;
    }

    function safeJsonParse(str, fallback) {
      try { return JSON.parse(str); } catch { return fallback; }
    }

    function computeFLProgression(actual, target) {
      const t = Number(target || 0);
      const a = Number(actual || 0);
      if (!t || t <= 0) return "‚Äî";
      return Math.round((a / t) * 100) + " %";
    }

    function defaultFlBySeason() {
      return {
        "Printemps": { ordered: "", amount: "", plan: "" },
        "√ât√©": { ordered: "", amount: "", plan: "" },
        "Automne": { ordered: "", amount: "", plan: "" },
        "Hiver": { ordered: "", amount: "", plan: "" }
      };
    }

    function defaultEngagementByWave() {
      return {
        wave1: { name: "", amount: "" },
        wave2: { name: "", amount: "" },
        wave3: { name: "", amount: "" },
        wave4: { name: "", amount: "" },
        wave5: { name: "", amount: "" },
        wave6: { name: "", amount: "" }
      };
    }

    function normalizeFlData(any) {
      if (!any || typeof any !== "object") {
        return {
          meta: { commande: "" },
          seasons: defaultFlBySeason()
        };
      }
      if (any.seasons && typeof any.seasons === "object") {
        return {
          meta: { commande: (any.meta && typeof any.meta === "object") ? (any.meta.commande || "") : "" },
          seasons: ensureAllSeasons(any.seasons)
        };
      }
      return {
        meta: { commande: "" },
        seasons: ensureAllSeasons(any)
      };
    }

    function ensureAllSeasons(obj) {
      const base = defaultFlBySeason();
      const out = { ...base };
      SEASONS.forEach(s => {
        const d = obj?.[s];
        if (d && typeof d === "object") {
          out[s] = {
            ordered: d.ordered || "",
            amount: d.amount || "",
            plan: d.plan || ""
          };
        }
      });
      return out;
    }

    function normalizeEngagementByWave(raw) {
      const base = defaultEngagementByWave();
      if (!raw || typeof raw !== "object") return base;
      Object.keys(base).forEach(waveId => {
        if (!raw[waveId] || typeof raw[waveId] !== "object") {
          raw[waveId] = { name: "", amount: "" };
        } else {
          raw[waveId].name = raw[waveId].name || "";
          raw[waveId].amount = raw[waveId].amount || "";
        }
      });
      return raw;
    }

    function normalizeVisits(raw) {
  if (!Array.isArray(raw)) return [];
  return raw.map(v =>
    typeof v === "string"
      ? { date: v, note: "" }
      : { date: v.date, note: v.note || "" }
  );
}

    function updateFlKpisLive(storeId) {
      const totalActuel = computeFLActualTotal(storeId);
      const row = document.querySelector(`tr[data-id="${storeId}"]`);
      if (row) {
        const tds = row.querySelectorAll("td");
        if (tds[3]) tds[3].textContent = euro(totalActuel);
        if (tds[4]) {
          const target = getFlTarget(storeId);
          tds[4].textContent = computeFLProgression(totalActuel, target);
        }
      }
      const kpiActual = document.querySelector("[data-kpi-fl-actual]");
      if (kpiActual) kpiActual.textContent = euro(totalActuel);
    }

    function formatNumber(n) {
      if (n == null) return "-";
      const num = Number(n);
      if (Number.isNaN(num)) return "-";
      return num.toLocaleString("fr-FR");
    }

    function euro(n) {
      if (n == null || n === "" || Number.isNaN(Number(n))) return "‚Äî";
      return `${formatNumber(Number(n))} ‚Ç¨`;
    }

    function computeFLActualTotal(storeId) {
      const st = getStoreState(storeId);
      let total = 0;
      const seasons = st.flBySeason || defaultFlBySeason();
      Object.values(seasons).forEach(season => {
        const val = Number(season?.amount || 0);
        if (!Number.isNaN(val)) total += val;
      });
      return total;
    }

    function computeEngagementTotal(storeId) {
      const st = getStoreState(storeId);
      let total = 0;
      Object.entries(st.engagementByWave || {}).forEach(([waveId, data]) => {
        if (st.waves?.[waveId] === "Engag√©") {
          const val = Number(data?.amount || 0);
          if (!Number.isNaN(val)) total += val;
        }
      });
      return total;
    }
function getPromoState(storeId, month) {
  const st = getStoreState(storeId);
  if (!st.promoByMonth[month]) st.promoByMonth[month] = {};
  return st.promoByMonth[month];
}

function getPromoList(store, month) {
  const format = getStoreFormat(store);
  return PROMOS?.[month]?.[format] || PROMOS?.[month]?.proxi || [];
}

function computePromoPercent(store, month) {
  const list = getPromoList(store, month);
  if (!list.length) return "‚Äî";
  const state = getPromoState(store.id, month);
  const ordered = list.filter(p => state[p.id]?.checked).length;
  return Math.round((ordered / list.length) * 100);
}
    let STATE = {};

    async function loadStateFromSupabase() {
      STATE = {};
      
      try {
        console.log("üîÑ Chargement depuis Supabase...");
        
        const { data, error } = await sb.from("store_state").select("*");
        
        if (error) {
          console.error("‚ùå Erreur Supabase:", error.message);
          console.log("‚ö†Ô∏è D√©marrage avec √©tat vide");
          return;
        }
        
        if (!data || data.length === 0) {
          console.log("‚ÑπÔ∏è Aucune donn√©e - d√©marrage vide");
          return;
        }
        
        console.log("üì¶ Re√ßu:", data.length, "lignes");
        
        const cleanData = JSON.parse(JSON.stringify(data));
cleanData.forEach(row => {
  STATE[row.id] = {
  flBySeason: row.fl_by_season
    ? normalizeFlData(row.fl_by_season).seasons
    : defaultFlBySeason(),

  flCommande: row.fl_by_season?.meta?.commande || "",

  waves: row.waves || {},

  engagementByWave: normalizeEngagementByWave(
    row.engagement_by_wave || {}
  ),

  engNotesByWave: row.eng_notes_by_waves || {},

  visits: normalizeVisits(row.visits),

  buysEng: row.buys_eng || "",

  notesEng: row.notes_eng || "",

  promoByMonth: row.promo_by_month || {} 
};
});

console.log("‚úÖ Charg√©:", Object.keys(STATE).length, "magasins");
        
      } catch (err) {
        console.error("‚ùå Erreur:", err.message);
        console.log("‚ö†Ô∏è D√©marrage avec √©tat vide malgr√© l'erreur");
      }
    }

    function getStoreState(id) {
      if (!STATE[id]) {
        STATE[id] = {
          flBySeason: defaultFlBySeason(),
          flCommande: "",
          waves: {},
          engagementByWave: defaultEngagementByWave(),
          engNotesByWave: {},
          visits: [],
          buysEng: "",
          notesEng: "",
          promoByMonth: {},
        };
      } else {
        if (!STATE[id].flBySeason) STATE[id].flBySeason = defaultFlBySeason();
        if (!STATE[id].engagementByWave) STATE[id].engagementByWave = defaultEngagementByWave();
        if (!STATE[id].engNotesByWave) STATE[id].engNotesByWave = {};
        if (STATE[id].flCommande === undefined) STATE[id].flCommande = "";
        if (!STATE[id].visits) STATE[id].visits = [];
        if (!STATE[id].promoByMonth) STATE[id].promoByMonth = {};
      }
      return STATE[id];
    }

    const saveTimeouts = {};

function saveWithDebounce(storeId) {
  clearTimeout(saveTimeouts[storeId]);
  saveTimeouts[storeId] = setTimeout(() => {
    saveStoreToSupabase(storeId);
  }, 800);
}

    async function saveStoreToSupabase(id) {
      const st = getStoreState(id);
      const flPayload = {
        meta: { commande: st.flCommande || "" },
        seasons: st.flBySeason || defaultFlBySeason()
      };

      // ‚úÖ Conversion explicite en JSON pur (pas d'objets non-s√©rialisables)
      const payload = {
        id: id,
        fl_by_season: JSON.parse(JSON.stringify(flPayload)),
        waves: JSON.parse(JSON.stringify(st.waves || {})),
        engagement_by_wave: JSON.parse(JSON.stringify(st.engagementByWave || {})),
        eng_notes_by_waves: JSON.parse(JSON.stringify(st.engNotesByWave || {})),
        visits: JSON.parse(JSON.stringify(st.visits || [])),
        buys_eng: st.buysEng || "",
        notes_eng: st.notesEng || "",
        promo_by_month: JSON.parse(JSON.stringify(st.promoByMonth || {})),
      };

      try {
        const { data, error } = await sb
          .from("store_state")
          .upsert(payload, { onConflict: 'id' });

        if (error) {
          console.error("‚ùå Erreur de sauvegarde Supabase :", error.message || error);
          alert("Erreur de sauvegarde : " + (error.message || "V√©rifiez la console"));
        } else {
          console.log("‚úÖ Donn√©es sauvegard√©es pour :", id);
        }
      } catch (err) {
        console.error("‚ùå Erreur lors de la sauvegarde :", err);
        alert("Erreur critique lors de la sauvegarde. Consultez la console.");
      }
    }

    const root = document.getElementById("root");
    let currentUser = null;
    let currentCommercialFilter = null;
    let currentTab = "overview";
    let currentStoreId = null;
    let currentSearch = "";
    let currentEngWave = "wave1";
    let currentFlSeason = "Printemps";

    function getUserStores(user) {
      if (!user) return [];
      if (user.role === "admin") {
        if (currentCommercialFilter) return STORES.filter(s => s.commercialId === currentCommercialFilter);
        return STORES;
      }
      return STORES.filter(s => s.commercialId === user.id);
    }

    function computeKpis(user) {
      const stores = getUserStores(user);
      const totalStores = stores.length;
      const totalCA = stores.reduce((sum, s) => sum + (s.ca2024 || 0), 0);
      let engagedStores = 0;
      stores.forEach(s => {
        const st = getStoreState(s.id);
        const hasEng = WAVES.some(w => st.waves[w.id] === "Engag√©");
        if (hasEng) engagedStores++;
      });
      const avgCA = totalStores ? Math.round(totalCA / totalStores) : 0;
      return { totalStores, totalCA, avgCA, engagedStores };
    }

    function computeFlKpis(user) {
      const stores = getUserStores(user);
      let totalTarget = 0;
      let totalActual = 0;
      stores.forEach(s => {
        totalTarget += getFlTarget(s.id);
        totalActual += computeFLActualTotal(s.id);
      });
      const progression = computeFLProgression(totalActual, totalTarget);
      return { totalTarget, totalActual, progression };
    }

    function renderLogin() {
      root.innerHTML = "";
      const wrap = document.createElement("div");
      wrap.className = "app-shell";
      const card = document.createElement("div");
      card.className = "card login-card";
      card.innerHTML = `
        <h1><span class="logo-dot"></span> CRM PROXI</h1>
        <div class="subtext">Connexion commercial ou admin (Marie-Charlotte / Xavier).</div>
        <div class="field" style="margin-top:16px;">
          <label>Type de profil</label>
          <select id="roleSelect">
            <option value="commercial">Commercial</option>
            <option value="admin">Admin</option>
          </select>
        </div>
        <div class="field">
          <label>Utilisateur</label>
          <select id="userSelect"></select>
        </div>
        <button id="loginBtn">Entrer dans le CRM</button>
        <div class="subtext" style="margin-top:8px;">Les donn√©es sont sauvegard√©es sur un serveur s√©curis√© (Supabase) et partag√©es entre les utilisateurs.</div>
      `;
      wrap.appendChild(card);
      root.appendChild(wrap);

      const roleSelect = card.querySelector("#roleSelect");
      const userSelect = card.querySelector("#userSelect");

      function refreshUserOptions() {
        const role = roleSelect.value;
        userSelect.innerHTML = "";
        const list = role === "admin" ? USERS.admins : USERS.commerciaux;
        list.forEach(u => {
          const opt = document.createElement("option");
          opt.value = u.id;
          opt.textContent = u.name;
          userSelect.appendChild(opt);
        });
      }
      roleSelect.addEventListener("change", refreshUserOptions);
      refreshUserOptions();

      card.querySelector("#loginBtn").addEventListener("click", () => {
        const role = roleSelect.value;
        const id = userSelect.value;
        if (!id) return;
        if (role === "admin") {
          currentUser = { ...USERS.admins.find(a => a.id === id) };
        } else {
          currentUser = { ...USERS.commerciaux.find(c => c.id === id), role: "commercial" };
        }
        currentCommercialFilter = null;
        currentTab = "overview";
        currentStoreId = null;
        currentSearch = "";
        currentFlSeason = "Printemps";
        currentEngWave = "wave1";
        renderApp();
      });
    }

    function renderApp() {
      root.innerHTML = "";
      const shell = document.createElement("div");
      shell.className = "app-shell";

      const sidebar = document.createElement("div");
      sidebar.className = "sidebar card";
      sidebar.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:8px;">
          <div>
            <div style="font-size:13px;color:var(--muted);opacity:.85;">Connect√© en tant que</div>
            <div style="font-size:15px;font-weight:600;">${currentUser.name}</div>
            <div style="font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:.08em;opacity:.8;">
              ${currentUser.role === "admin" ? "Admin ¬∑ vue globale" : "Commercial ¬∑ portefeuille magasins"}
            </div>
          </div>
          <button class="secondary" id="logoutBtn">Quitter</button>
        </div>
      `;

      const listWrap = document.createElement("div");
      listWrap.className = "list";

      const commList = currentUser.role === "admin"
        ? USERS.commerciaux
        : USERS.commerciaux.filter(c => c.id === currentUser.id);

      const storesAll = getUserStores(currentUser);
      const byCommercial = {};
      storesAll.forEach(s => {
        byCommercial[s.commercialId] = (byCommercial[s.commercialId] || 0) + 1;
      });

      commList.forEach(c => {
        const row = document.createElement("div");
        row.className = "commercial-row";
        if (currentCommercialFilter === c.id || currentUser.id === c.id) row.classList.add("active");
        row.innerHTML = `
          <div>
            <div class="commercial-name">${c.name}</div>
            <div class="commercial-meta">${byCommercial[c.id] || 0} magasin(s)</div>
          </div>
        `;
        row.addEventListener("click", () => {
          if (currentUser.role === "admin") {
            currentCommercialFilter = c.id;
            currentStoreId = null;
            currentTab = "overview";
            currentSearch = "";
            currentFlSeason = "Printemps";
            renderApp();
          }
        });
        listWrap.appendChild(row);
      });

      sidebar.appendChild(listWrap);

      const main = document.createElement("div");
      main.className = "main";

      const kpiCard = document.createElement("div");
      kpiCard.className = "card";

      if (currentTab === "fl") {
        const fl = computeFlKpis(currentUser);
        kpiCard.innerHTML = `
          <h1><span class="logo-dot"></span> CRM PROXI ¬∑ Fruits & L√©gumes</h1>
          <div class="subtext">Suivi F&L par saison (commande / montant / plan d'action).</div>
          <div class="kpi-row">
            <div class="kpi-card">
              <div class="kpi-label">Total montants 2025 (objectif)</div>
              <div class="kpi-value">${euro(fl.totalTarget)}</div>
            </div>
            <div class="kpi-card">
              <div class="kpi-label">Total montant actuel</div>
              <div class="kpi-value">${euro(fl.totalActual)}</div>
            </div>
            <div class="kpi-card">
              <div class="kpi-label">Progression</div>
              <div class="kpi-value">${fl.progression}</div>
            </div>
            <div class="kpi-card">
              <div class="kpi-label">√âcart (actuel - objectif)</div>
              <div class="kpi-value">${euro(Number(fl.totalActual) - Number(fl.totalTarget))}</div>
            </div>
          </div>
        `;
      } else {
        const kpis = computeKpis(currentUser);
        kpiCard.innerHTML = `
          <h1><span class="logo-dot"></span> CRM PROXI</h1>
          <div class="subtext">Vue d'ensemble du portefeuille.</div>
          <div class="kpi-row">
            <div class="kpi-card">
              <div class="kpi-label">Magasins</div>
              <div class="kpi-value">${kpis.totalStores}</div>
            </div>
            <div class="kpi-card">
              <div class="kpi-label">CA total</div>
              <div class="kpi-value">${formatNumber(kpis.totalCA)} ‚Ç¨</div>
            </div>
            <div class="kpi-card">
              <div class="kpi-label">CA moyen</div>
              <div class="kpi-value">${formatNumber(kpis.avgCA)} ‚Ç¨</div>
            </div>
            <div class="kpi-card">
              <div class="kpi-label">Magasins engag√©s</div>
              <div class="kpi-value">${kpis.engagedStores}</div>
            </div>
          </div>
        `;
      }

      main.appendChild(kpiCard);

      const mainCard = document.createElement("div");
      mainCard.className = "card";
      mainCard.innerHTML = `
        <div class="tabs">
  <button class="tab-btn ${currentTab === "overview" ? "active" : ""}" data-tab="overview">Vue d'ensemble</button>
  <button class="tab-btn ${currentTab === "list" ? "active" : ""}" data-tab="list">Magasins</button>
  <button class="tab-btn ${currentTab === "fl" ? "active" : ""}" data-tab="fl">Fruits & L√©gumes</button>
  <button class="tab-btn ${currentTab === "eng" ? "active" : ""}" data-tab="eng">Engagement</button>
  <button class="tab-btn ${currentTab === "promo" ? "active" : ""}" data-tab="promo">Promo</button>
</div>
      `;

      const content = document.createElement("div");
      content.className = "two-columns";

      const stores = getUserStores(currentUser);
      if (!currentStoreId && stores.length) currentStoreId = stores[0].id;
      const currentStore = stores.find(s => s.id === currentStoreId);

      if (currentTab === "overview") {
  content.innerHTML = `
    <div>
      <div style="font-size:13px;font-weight:600;">Vue d‚Äôensemble ¬∑ Magasins</div>
      <table>
        <thead>
          <tr>
            <th>Magasin</th>
            <th>CA 2025</th>
            <th>Visites</th>
          </tr>
        </thead>
        <tbody>
          ${stores.map(s => {
            const visitsCount = getStoreState(s.id).visits.length;
            return `
              <tr>
  <td>${s.name}</td>
  <td>${formatNumber(s.ca2024)} ‚Ç¨</td>
  <td>${visitsCount}</td>
</tr>
            `;
          }).join("")}
        </tbody>
      </table>
    </div>
  `;
      } else if (currentTab === "list") {
        renderStoresTab(content, stores, currentStore);
      } else if (currentTab === "fl") {
        renderFruitsLegumesTab(content, stores, currentStore);
      } else if (currentTab === "eng") {
        renderEngagementTab(content, stores, currentStore);
      }
      else if (currentTab === "promo") {
  renderPromoTab(content, stores, currentStore);
}

      mainCard.appendChild(content);
      main.appendChild(mainCard);

      sidebar.querySelector("#logoutBtn").addEventListener("click", () => {
        currentUser = null;
        currentCommercialFilter = null;
        currentStoreId = null;
        currentTab = "overview";
        currentFlSeason = "Printemps";
        currentEngWave = "wave1";
        renderLogin();
      });

     mainCard.querySelectorAll(".tab-btn[data-tab]").forEach(btn => {
  btn.addEventListener("click", () => {
    currentTab = btn.dataset.tab;
    renderApp();
  });
});

      shell.appendChild(sidebar);
      shell.appendChild(main);
      root.appendChild(shell);
    }

    function renderStoresTab(container, stores, currentStore) {
      const left = document.createElement("div");
      const right = document.createElement("div");

      left.innerHTML = `
        <div>
          <div style="font-size:13px;font-weight:600;">Magasins ¬∑ Suivi terrain</div>
          <div class="subtext">Clique sur un magasin pour voir le d√©tail.</div>
        </div>
        <table>
          <thead>
          <tr>
    <th>Magasin</th>
    <th>Visites</th>
  </tr>
</thead>
          <tbody>
            ${stores.map(s => {
              const visitsCount = getStoreState(s.id).visits.length;
              return `
                <tr data-id="${s.id}">
                  <td>${s.name}</td>
                 <td>${visitsCount}</td>
                </tr>
              `;
            }).join("")}
          </tbody>
        </table>
      `;

      left.querySelectorAll("tbody tr").forEach(tr => {
        tr.addEventListener("click", () => {
          currentStoreId = tr.dataset.id;
          renderApp();
        });
      });

      if (!currentStore) {
        right.innerHTML = `<div class="subtext">S√©lectionne un magasin.</div>`;
        container.appendChild(left);
        container.appendChild(right);
        return;
      }

      const st = getStoreState(currentStore.id);

      right.innerHTML = `
        <div style="font-size:13px;font-weight:600;">${currentStore.name}</div>
        <div class="card" style="margin-top:10px;padding:12px;">
          <div style="font-size:13px;font-weight:600;">Visites terrain</div>
          <div style="margin-top:6px;">
          ${st.visits.length
  ? st.visits.slice().reverse().map((visit, i) => {
      const idx = st.visits.length - 1 - i;
      return `
        <div style="margin-bottom:8px;">
          <input type="date" value="${visit.date}" data-edit-visit="${idx}" />
          <textarea
            rows="2"
            placeholder="Commentaire de visite"
            data-note-visit="${idx}"
          >${visit.note || ""}</textarea>
          <button class="secondary" data-delete-visit="${idx}">üóëÔ∏è</button>
        </div>
      `;
    }).join("")
  : `<span class="subtext">Aucune visite renseign√©e</span>`
}
          </div>
          <button id="addVisitBtn" style="margin-top:8px;">+ Ajouter une visite aujourd'hui</button>
        </div>
      `;

      right.querySelector("#addVisitBtn").addEventListener("click", () => {
        const today = new Date().toISOString().slice(0, 10);
        if (!st.visits.some(v => v.date === today)) {
        st.visits.push({
  date: today,
  note: ""
});
          saveStoreToSupabase(currentStore.id);
          renderApp();
        }
      });

     right.querySelectorAll("[data-edit-visit]").forEach(inp => {
  inp.addEventListener("change", () => {
    const index = Number(inp.dataset.editVisit);
    const newDate = inp.value;
    if (!newDate) return;

    if (st.visits.some((v, i) => v.date === newDate && i !== index)) {
      alert("Une visite existe d√©j√† √† cette date.");
      renderApp();
      return;
    }

    st.visits[index].date = newDate; 
    saveStoreToSupabase(currentStore.id);
    renderApp();
  });
});
right.querySelectorAll("[data-note-visit]").forEach(txt => {
  txt.addEventListener("blur", () => {
    const index = Number(txt.dataset.noteVisit);
    st.visits[index].note = txt.value;
    saveWithDebounce(currentStore.id);
  });
});

      right.querySelectorAll("[data-delete-visit]").forEach(btn => {
        btn.addEventListener("click", () => {
          const index = Number(btn.dataset.deleteVisit);
          if (!confirm("Supprimer cette visite ?")) return;
          st.visits.splice(index, 1);
          saveStoreToSupabase(currentStore.id);
          renderApp();
        });
      });

      container.appendChild(left);
      container.appendChild(right);
    }

    function renderFruitsLegumesTab(container, stores, currentStore) {
      container.innerHTML = "";
      const left = document.createElement("div");
      const right = document.createElement("div");

      left.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;">
          <div>
            <div style="font-size:13px;font-weight:600;">Magasins ¬∑ Fruits & L√©gumes</div>
            <div class="subtext">Aper√ßu F&L (commande + objectif + actuel + progression), puis d√©tail par saisons √† droite.</div>
          </div>
        </div>
        <table>
          <thead>
            <tr>
              <th>Magasin</th>
              <th>Commande</th>
              <th>Total montants 2025</th>
              <th>Total montant actuel</th>
              <th>Progression</th>
            </tr>
          </thead>
          <tbody>
            ${stores.map(s => {
              const st = getStoreState(s.id);
              const commande = st.flCommande || "";
              const total2025 = getFlTarget(s.id);
              const totalActuel = computeFLActualTotal(s.id);
              const progression = computeFLProgression(totalActuel, total2025);
              return `
                <tr data-id="${s.id}">
                  <td>${s.name}</td>
                  <td>
                    <select data-fl-commande="${s.id}">
                      <option value="">NC</option>
                      <option value="Oui" ${commande === "Oui" ? "selected" : ""}>Oui</option>
                      <option value="Non" ${commande === "Non" ? "selected" : ""}>Non</option>
                    </select>
                  </td>
                  <td>${euro(total2025)}</td>
                  <td>${euro(totalActuel)}</td>
                  <td>${progression}</td>
                </tr>
              `;
            }).join("")}
          </tbody>
        </table>
      `;

      left.querySelectorAll("tbody tr").forEach(tr => {
        tr.addEventListener("click", e => {
          if (e.target.tagName.toLowerCase() === "select") return;
          currentStoreId = tr.dataset.id;
          renderApp();
        });
      });

      left.querySelectorAll("select[data-fl-commande]").forEach(sel => {
        sel.addEventListener("change", () => {
          const id = sel.dataset.flCommande;
          const st = getStoreState(id);
          st.flCommande = sel.value;
          saveStoreToSupabase(id);
        });
      });
  if (currentStore) {
  renderFlRightPanel(right, currentStore);
} else {
  right.innerHTML = '<div class="subtext">S√©lectionne un magasin dans la liste.</div>';
}

      container.appendChild(left);
      container.appendChild(right);
    }

    function updateEngagementRow(storeId) {
      const row = document.querySelector(`tr[data-id="${storeId}"]`);
      if (!row) return;
      const st = getStoreState(storeId);
      const engagedCount = WAVES.filter(w => st.waves[w.id] === "Engag√©").length;
      const total = computeEngagementTotal(storeId);
      const tds = row.querySelectorAll("td");
      if (tds[1]) tds[1].textContent = engagedCount;
      if (tds[2]) tds[2].textContent = euro(total);
    }

    function renderEngagementTab(container, stores, currentStore) {
      const left = document.createElement("div");
      const right = document.createElement("div");

      left.innerHTML = `
        <div>
          <div style="font-size:13px;font-weight:600;">Magasins ¬∑ Engagement</div>
          <div class="subtext">Suivi des vagues d'engagement.</div>
        </div>
        <table>
          <thead>
            <tr>
              <th>Magasin</th>
              <th>Vagues engag√©es</th>
              <th>Total engag√©</th>
            </tr>
          </thead>
          <tbody>
            ${stores.map(s => {
              const st = getStoreState(s.id);
              const engagedCount = WAVES.filter(w => st.waves[w.id] === "Engag√©").length;
              const total = computeEngagementTotal(s.id);
              return `
                <tr data-id="${s.id}">
                  <td>${s.name}</td>
                  <td>${engagedCount}</td>
                  <td>${euro(total)}</td>
                </tr>
              `;
            }).join("")}
          </tbody>
        </table>
      `;

      left.querySelectorAll("tbody tr").forEach(tr => {
        tr.addEventListener("click", () => {
          currentStoreId = tr.dataset.id;
          renderApp();
        });
      });

      if (!currentStore) {
        right.innerHTML = `<div class="subtext">S√©lectionne un magasin.</div>`;
        container.appendChild(left);
        container.appendChild(right);
        return;
      }

      if (currentStore) {
  renderEngRightPanel(right, currentStore);
} else {
  right.innerHTML = '<div class="subtext">S√©lectionne un magasin.</div>';
}

      container.appendChild(left);
      container.appendChild(right);
    }
    function renderFlRightPanel(right, currentStore) {
  const st = getStoreState(currentStore.id);

  if (!SEASONS.includes(currentFlSeason)) currentFlSeason = "Printemps";
  const data = st.flBySeason[currentFlSeason] || { ordered: "", amount: "", plan: "" };

  const totalActuel = computeFLActualTotal(currentStore.id);
  const totalTarget = getFlTarget(currentStore.id);
  const progression = totalTarget > 0
    ? Math.round((totalActuel / totalTarget) * 100) + " %"
    : "‚Äî";

  right.innerHTML = `
    <div style="font-size:13px;font-weight:600;">${currentStore.name}</div>
    <div class="card" style="margin-top:10px;padding:12px;">
      <div class="subtext">
        Objectif : <b>${euro(totalTarget)}</b> ¬∑
        Actuel : <b data-kpi-fl-actual>${euro(totalActuel)}</b> ¬∑
        Progression : <b>${progression}</b>
      </div>
    </div>

    <div class="card" style="margin-top:10px;padding:12px;">
      <div class="tabs">
        ${SEASONS.map(season => `
          <button class="tab-btn ${currentFlSeason === season ? "active" : ""}"
                  data-fl-season="${season}">
            ${season}
          </button>
        `).join("")}
      </div>

      <label>Commande F&L</label>
      <select id="seasonOrdered">
        <option value="">NC</option>
        <option value="Oui" ${data.ordered === "Oui" ? "selected" : ""}>Oui</option>
        <option value="Non" ${data.ordered === "Non" ? "selected" : ""}>Non</option>
      </select>

      <label>Montant (‚Ç¨)</label>
      <input type="number" id="seasonAmount" value="${data.amount || ""}" />

      <label>Plan d'action</label>
      <textarea id="seasonPlan" rows="4">${data.plan || ""}</textarea>
    </div>
  `;

  right.querySelector("#seasonOrdered").onchange = e => {
    st.flBySeason[currentFlSeason].ordered = e.target.value;
    saveWithDebounce(currentStore.id);
  };

  right.querySelector("#seasonAmount").onblur = e => {
    st.flBySeason[currentFlSeason].amount = e.target.value;
    updateFlKpisLive(currentStore.id);
    saveWithDebounce(currentStore.id);
  };

  right.querySelector("#seasonPlan").onblur = e => {
    st.flBySeason[currentFlSeason].plan = e.target.value;
    saveWithDebounce(currentStore.id);
  };

  right.querySelectorAll("[data-fl-season]").forEach(btn => {
    btn.onclick = (e) => {
  e.stopPropagation();
  currentFlSeason = btn.dataset.flSeason;
  renderFlRightPanel(right, currentStore);
};
  });
}
    function renderEngRightPanel(right, currentStore) {
  const st = getStoreState(currentStore.id);
  const wave = WAVES.find(w => w.id === currentEngWave);
  const data = st.engagementByWave[currentEngWave] || { name: "", amount: "" };
  const status = st.waves[currentEngWave] || "Non concern√©";
  const notes = st.engNotesByWave?.[currentEngWave] || "";

  right.innerHTML = `
    <div style="font-size:13px;font-weight:600;">${currentStore.name}</div>

    <div class="card" style="margin-top:10px;padding:12px;">
      <div class="tabs">
        ${WAVES.map(w => `
          <button class="tab-btn ${currentEngWave === w.id ? "active" : ""}"
                  data-eng-wave="${w.id}">
            ${w.label}
          </button>
        `).join("")}
      </div>
    </div>

    <div class="card" style="margin-top:10px;padding:12px;">
      <label>Statut</label>
      <select id="engStatus">
        ${WAVE_STATUSES.map(s => `
          <option ${s === status ? "selected" : ""}>${s}</option>
        `).join("")}
      </select>

      <label>Nom</label>
      <input id="engName" value="${data.name || ""}" />

      <label>Montant</label>
      <input type="number" id="engAmount" value="${data.amount || ""}" />

      <label>Notes</label>
      <textarea id="engNotes">${notes}</textarea>
    </div>
  `;

  right.querySelectorAll("[data-eng-wave]").forEach(btn => {
  btn.onclick = (e) => {
    e.stopPropagation();
    currentEngWave = btn.dataset.engWave;
    renderEngRightPanel(right, currentStore);
  };
});

  right.querySelector("#engStatus").onchange = e => {
    st.waves[currentEngWave] = e.target.value;
    updateEngagementRow(currentStore.id);
    saveWithDebounce(currentStore.id);
  };

  right.querySelector("#engName").onblur = e => {
    st.engagementByWave[currentEngWave].name = e.target.value;
    saveWithDebounce(currentStore.id);
  };

  right.querySelector("#engAmount").onblur = e => {
    st.engagementByWave[currentEngWave].amount = e.target.value;
    updateEngagementRow(currentStore.id);
    saveWithDebounce(currentStore.id);
  };

  right.querySelector("#engNotes").onblur = e => {
    st.engNotesByWave[currentEngWave] = e.target.value;
    saveWithDebounce(currentStore.id);
  };
}
 let currentPromoMonth = "2026-01";

function renderPromoTab(container, stores, currentStore) {
  container.innerHTML = "";

  const left = document.createElement("div");
  const right = document.createElement("div");

  left.innerHTML = `
    <div style="font-size:13px;font-weight:600;">Promotions ¬∑ ${currentPromoMonth}</div>
    <table>
      <thead>
        <tr>
          <th>Magasin</th>
          <th>% command√©</th>
        </tr>
      </thead>
      <tbody>
  ${stores.map(s => {
    const percent = computePromoPercent(s, currentPromoMonth);
    return `
      <tr data-id="${s.id}">
        <td>${s.name}</td>
        <td>${percent === "‚Äî" ? "‚Äî" : percent + " %"}</td>
      </tr>
    `;
  }).join("")}
</tbody>
    </table>
  `;

  left.querySelectorAll("tbody tr").forEach(tr => {
    tr.addEventListener("click", () => {
      currentStoreId = tr.dataset.id;
      renderApp();
    });
  });

  if (!currentStore) {
    right.innerHTML = `<div class="subtext">S√©lectionne un magasin</div>`;
    container.appendChild(left);
    container.appendChild(right);
    return;
  }

  const promoList = getPromoList(currentStore, currentPromoMonth);
  const promoState = getPromoState(currentStore.id, currentPromoMonth);

  right.innerHTML = `
    <div style="font-size:13px;font-weight:600;">${currentStore.name}</div>
    <table>
      <thead>
        <tr>
          <th>Produit</th>
          <th>Command√©</th>
          <th>Commentaire</th>
        </tr>
      </thead>
      <tbody>
        ${promoList.map(p => `
          <tr>
            <td>${p.label}</td>
            <td>
              <input type="checkbox"
                ${promoState[p.id]?.checked ? "checked" : ""}
                data-check="${p.id}">
            </td>
            <td>
              <input type="text"
                value="${promoState[p.id]?.note || ""}"
                data-note="${p.id}">
            </td>
          </tr>
        `).join("")}
      </tbody>
    </table>
  `;

  right.querySelectorAll("[data-check]").forEach(cb => {
    cb.addEventListener("change", () => {
      const id = cb.dataset.check;
      promoState[id] = promoState[id] || {};
      promoState[id].checked = cb.checked;
      saveWithDebounce(currentStore.id);
      renderApp();
    });
  });

  right.querySelectorAll("[data-note]").forEach(inp => {
    inp.addEventListener("blur", () => {
      const id = inp.dataset.note;
      promoState[id] = promoState[id] || {};
      promoState[id].note = inp.value;
      saveWithDebounce(currentStore.id);
    });
  });

  container.appendChild(left);
  container.appendChild(right);
}

    async function init() {
      await loadStateFromSupabase();
      renderLogin();
    }

    init();
  </script>
</body>
</html>
