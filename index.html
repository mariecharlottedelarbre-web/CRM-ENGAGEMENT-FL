<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mini CRM Fruits & L√©gumes</title>
  <style>
    :root {
      --bg: #1c1917;
      --card: #111827;
      --card-soft: #0f172a;
      --accent: #f97316;
      --accent-soft: rgba(248, 148, 56, 0.18);
      --text: #f9fafb;
      --muted: #e5e7eb;
      --border: #374151;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, 'SF Pro Text', sans-serif;
      background:
        radial-gradient(circle at top left, rgba(248, 148, 56, 0.35), transparent 55%),
        radial-gradient(circle at bottom right, rgba(34,197,94,0.22), transparent 55%),
        linear-gradient(145deg, #0b1120, #111827);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      align-items: stretch;
      justify-content: center;
    }
    .app-shell {
      width: 100%;
      max-width: 1400px;
      display: flex;
      gap: 16px;
      padding: 16px;
    }
    .card {
      background: linear-gradient(145deg, rgba(15,23,42,0.96), rgba(15,23,42,0.9));
      border-radius: 18px;
      padding: 18px 20px;
      border: 1px solid rgba(249,250,251,0.08);
      box-shadow: 0 18px 50px rgba(15,23,42,0.9);
    }
    .sidebar { width: 260px; display: flex; flex-direction: column; gap: 12px; }
    .main { flex: 1; display: flex; flex-direction: column; gap: 16px; }
    h1 {
      margin: 0 0 4px;
      font-size: 22px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .logo-dot {
      width: 9px; height: 9px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 20%, #fed7aa, #f97316);
      box-shadow: 0 0 18px rgba(248,148,56,0.9);
    }
    .subtext { font-size: 13px; color: var(--muted); opacity: .85; }
    .login-card { width: 100%; max-width: 420px; margin: auto; }
    .field { margin-bottom: 12px; }
    label { display: block; margin-bottom: 4px; font-size: 13px; color: var(--muted); opacity: .9; }
    select, input, textarea {
      width: 100%;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: rgba(15,23,42,0.9);
      color: var(--text);
      font-size: 13px;
      resize: vertical;
    }
    select:focus, input:focus, textarea:focus {
      outline: 1px solid var(--accent);
      border-color: var(--accent);
    }
    button {
      border: none;
      border-radius: 999px;
      padding: 8px 16px;
      background: radial-gradient(circle at 30% 0, #fed7aa, #f97316);
      color: #1c1917;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      box-shadow: 0 12px 30px rgba(248,148,56,0.55);
    }
    button.secondary {
      background: transparent;
      color: var(--muted);
      box-shadow: none;
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 12px;
    }
    .chip {
      padding: 4px 8px;
      border-radius: 999px;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: .08em;
      border: 1px solid rgba(249,250,251,0.3);
      color: var(--muted);
      background: rgba(15,23,42,0.9);
    }
    .chip.green { border-color: rgba(34,197,94,0.6); color: #bbf7d0; background: rgba(22,163,74,0.16); }

    .commercial-row {
      padding: 8px 10px;
      border-radius: 10px;
      margin-bottom: 6px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: rgba(15,23,42,0.88);
      border: 1px solid transparent;
    }
    .commercial-row.active { border-color: var(--accent); background: rgba(248,148,56,0.14); }
    .commercial-row:hover { border-color: rgba(249,250,251,0.32); }
    .commercial-name { font-size: 14px; }
    .commercial-meta { font-size: 11px; color: var(--muted); opacity: .8; }
    .list { margin-top: 10px; max-height: calc(100vh - 230px); overflow: auto; }

    .kpi-row {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 10px;
      margin-top: 10px;
    }
    .kpi-card {
      padding: 10px 12px;
      border-radius: 14px;
      background: radial-gradient(circle at 0 0, rgba(248,148,56,0.16), rgba(15,23,42,0.98));
      border: 1px solid rgba(249,250,251,0.14);
      font-size: 12px;
    }
    .kpi-label { color: var(--muted); font-size: 11px; opacity:.9; }
    .kpi-value { font-size: 17px; font-weight: 600; margin-top: 3px; }
    .kpi-sub { font-size: 11px; color: var(--muted); opacity:.8; }

    .tabs {
      display: inline-flex;
      padding: 3px;
      border-radius: 999px;
      background: rgba(15,23,42,0.95);
      border: 1px solid rgba(249,250,251,0.2);
    }
    .tab-btn {
      border-radius: 999px;
      padding: 6px 14px;
      font-size: 12px;
      border: none;
      background: transparent;
      color: var(--muted);
      cursor: pointer;
    }
    .tab-btn.active {
      background: rgba(248,148,56,0.9);
      color: #1c1917;
    }

    table { width: 100%; border-collapse: collapse; font-size: 12px; margin-top: 8px; }
    th, td {
      padding: 6px 8px;
      border-bottom: 1px solid rgba(31,41,55,0.9);
      text-align: left;
      vertical-align: top;
    }
    th { font-size: 11px; color: var(--muted); text-transform: uppercase; letter-spacing: .06em; opacity:.8; }
    tr:hover td { background: rgba(15,23,42,0.9); cursor: pointer; }

    .two-columns {
      display: grid;
      grid-template-columns: minmax(0, 1.2fr) minmax(0, 1fr);
      gap: 12px;
      margin-top: 10px;
      align-items: flex-start;
    }

    .seasons { display:flex; flex-wrap:wrap; gap:6px; margin-top:4px; }
    .season-pill {
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 11px;
      border: 1px solid rgba(249,250,251,0.3);
      cursor: pointer;
      background: rgba(15,23,42,0.9);
    }
    .season-pill.active {
      border-color: rgba(34,197,94,0.7);
      background: rgba(22,163,74,0.2);
      color: #bbf7d0;
    }

    .waves-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap: 8px;
      margin-top: 8px;
    }
    .wave-card {
      padding: 6px 8px;
      border-radius: 10px;
      background: rgba(15,23,42,0.96);
      border: 1px solid rgba(55,65,81,0.9);
      font-size: 11px;
    }
    .wave-title { font-weight: 600; margin-bottom: 4px; }

    .search-row { margin-top: 6px; margin-bottom: 4px; }
    .search-input {
      width: 100%;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(15,23,42,0.95);
      color: var(--text);
      font-size: 12px;
    }
    .search-input::placeholder { color: rgba(229,231,235,0.6); }

    .bar-chart { margin-top: 10px; }
    .bar-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px;
      font-size: 11px;
    }
    .bar-label {
      width: 140px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      color: var(--muted);
    }
    .bar-bg {
      flex: 1;
      height: 8px;
      border-radius: 999px;
      background: rgba(55,65,81,0.9);
      overflow: hidden;
    }
    .bar-fill {
      height: 100%;
      border-radius: 999px;
      background: linear-gradient(to right, #22c55e, #bef264);
    }
    .bar-value {
      width: 40px;
      text-align: right;
      color: var(--muted);
    }

    .status-pill {
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 10px;
      border: 1px solid rgba(249,250,251,0.25);
      color: var(--muted);
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    @media (max-width: 900px) {
      .app-shell { flex-direction: column; }
      .sidebar { width: 100%; }
      .two-columns { grid-template-columns: minmax(0,1fr); }
      .kpi-row { grid-template-columns: repeat(2,minmax(0,1fr)); }
    }
  </style>
</head>
<body>
  <div id="root" style="width:100%"></div>

  <!-- üì° Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    // --- Connexion Supabase (partage CRM) ---
    const SUPABASE_URL = "https://sytpnqayyyjdjhojafyi.supabase.co";
    const SUPABASE_KEY = "sb_publishable_5ernJ3tbCW3XnAdx983E8A_ASPSKBVx";

    const { createClient } = supabase;
    const sb = createClient(SUPABASE_URL, SUPABASE_KEY);
    // Pour l‚Äôinstant, on se contente de connecter la base.
    // On branchera la sauvegarde/lecture des donn√©es dessus ensuite.

    /********* UTILISATEURS *********/
    const USERS = {
      admins: [
        { id: "admin-marie-charlotte", name: "Marie-Charlotte", role: "admin" },
        { id: "admin-xavier",          name: "Xavier",          role: "admin" }
      ],
      commerciaux: [
        { id: "costanza-damien",      name: "COSTANZA Damien" },
        { id: "besquent-dominique",   name: "BESQUENT Dominique" },
        { id: "hamparsoumiam-armand", name: "HAMPARSOUMIAN Armand" },
        { id: "juif-olivier",         name: "JUIF Olivier" },
        { id: "laurent-severine",     name: "LAURENT S√©verine" },
        { id: "michelet-yves",        name: "MICHELET Yves" },
        { id: "aydogan-nevin",        name: "AYDOGAN Nevin" },
        { id: "vernay-benoit",        name: "VERNAY Benoit" }
      ]
    };

    /********* MAGASINS : 10 PAR COMMERCIAL *********/
    const STORES = [
      // COSTANZA Damien
      { id: "montpellier-delicie",  name: "Montpellier-delicie",  ca2024: 744909, commercialId: "costanza-damien" },
      { id: "poulx",                name: "Poulx",                ca2024: 499321, commercialId: "costanza-damien" },
      { id: "saint-jean-du-gard",   name: "Saint-Jean-Du-Gard",   ca2024: 475888, commercialId: "costanza-damien" },
      { id: "moussac",              name: "Moussac",              ca2024: 459254, commercialId: "costanza-damien" },
      { id: "lus-la-croix-haute",   name: "Lus-La-Croix-Haute",   ca2024: 447167, commercialId: "costanza-damien" },
      { id: "marseille-st-antoin",  name: "Marseille -St Antoin", ca2024: 305369, commercialId: "costanza-damien" },
      { id: "valras-plage-rompud",  name: "Valras-Plage -Rompud", ca2024: 280196, commercialId: "costanza-damien" },
      { id: "martigues-couronne",   name: "Martigues -Couronne",  ca2024: 270889, commercialId: "costanza-damien" },
      { id: "vercheny",             name: "Vercheny",             ca2024: 269919, commercialId: "costanza-damien" },
      { id: "palavas-magdelone",    name: "Palavas -Magdelone",   ca2024: 266890, commercialId: "costanza-damien" },

      // BESQUENT Dominique
      { id: "bargemon",             name: "Bargemon",             ca2024: 1013279, commercialId: "besquent-dominique" },
      { id: "colmars-les-alpes",    name: "Colmars Les Alpes",    ca2024: 982321,  commercialId: "besquent-dominique" },
      { id: "la-palud-s-verdon",    name: "La Palud S/Verdon",    ca2024: 659872,  commercialId: "besquent-dominique" },
      { id: "frejus-anc-comb-afn",  name: "Frejus -Anc.Comb.Afn", ca2024: 589851,  commercialId: "besquent-dominique" },
      { id: "comps-s-artuby-crx",   name: "Comps S/Artuby -Crx",  ca2024: 525388,  commercialId: "besquent-dominique" },
      { id: "riez-rouguiere",       name: "Riez -Rouguiere",      ca2024: 493257,  commercialId: "besquent-dominique" },
      { id: "callas",               name: "Callas",               ca2024: 465658,  commercialId: "besquent-dominique" },
      { id: "greoux-les-bains",     name: "Greoux-Les-Bains",     ca2024: 454009,  commercialId: "besquent-dominique" },
      { id: "pra-loup-placette",    name: "Pra Loup -Placette",   ca2024: 420977,  commercialId: "besquent-dominique" },
      { id: "frejus-afriq-n-3775",  name: "Frejus -Afriq.N.3775", ca2024: 406918,  commercialId: "besquent-dominique" },

      // HAMPARSOUMIAN Armand
      { id: "apt-marchands",        name: "Apt -Marchands",       ca2024: 829091,  commercialId: "hamparsoumiam-armand" },
      { id: "calacussia",           name: "Calacussia",           ca2024: 750643,  commercialId: "hamparsoumiam-armand" },
      { id: "savines-le-lac",       name: "Savines Le Lac",       ca2024: 515774,  commercialId: "hamparsoumiam-armand" },
      { id: "orcieres-merlette",    name: "Orcieres Merlette",    ca2024: 482127,  commercialId: "hamparsoumiam-armand" },
      { id: "l-ile-rousse",         name: "L'ile Rousse",         ca2024: 464605,  commercialId: "hamparsoumiam-armand" },
      { id: "malemort-du-comtat",   name: "Malemort-Du-Comtat",   ca2024: 455693,  commercialId: "hamparsoumiam-armand" },
      { id: "ceillac-rue-ppl",      name: "Ceillac Rue Ppl",      ca2024: 433551,  commercialId: "hamparsoumiam-armand" },
      { id: "mirabeau-rd973",       name: "Mirabeau -Rd973",      ca2024: 407051,  commercialId: "hamparsoumiam-armand" },
      { id: "montgenevre-obelisq",  name: "Montgenevre -Obelisq", ca2024: 345517,  commercialId: "hamparsoumiam-armand" },
      { id: "petreto-bicchisano",   name: "Petreto Bicchisano",   ca2024: 319139,  commercialId: "hamparsoumiam-armand" },

      // JUIF Olivier
      { id: "guillaumes",           name: "Guillaumes",           ca2024: 767652,  commercialId: "juif-olivier" },
      { id: "valdeblore-dalmas",    name: "Valdeblore -Dalmas",   ca2024: 648328,  commercialId: "juif-olivier" },
      { id: "st-etienne-de-tinee",  name: "St Etienne De Tinee",  ca2024: 604882,  commercialId: "juif-olivier" },
      { id: "carces",               name: "Carces",               ca2024: 571716,  commercialId: "juif-olivier" },
      { id: "nice-e-d-orves",       name: "Nice -E.D'orves",      ca2024: 563347,  commercialId: "juif-olivier" },
      { id: "nice-thiers",          name: "Nice -Thiers",         ca2024: 510335,  commercialId: "juif-olivier" },
      { id: "st-julien-83",         name: "St Julien (83)",       ca2024: 490883,  commercialId: "juif-olivier" },
      { id: "antibes-4-chemins",    name: "Antibes -4 Chemins",   ca2024: 452272,  commercialId: "juif-olivier" },
      { id: "bormes-les-mi-plage",  name: "Bormes Les Mi -Plage", ca2024: 450814,  commercialId: "juif-olivier" },
      { id: "le-pradet-herminier",  name: "Le Pradet -Herminier", ca2024: 435118,  commercialId: "juif-olivier" },

      // LAURENT S√©verine
      { id: "besse-e-st-anastasie", name: "Besse E St Anastasie", ca2024: 459176,  commercialId: "laurent-severine" },
      { id: "cunhlat",              name: "Cunhlat",              ca2024: 335815,  commercialId: "laurent-severine" },
      { id: "varennes-st-sauveur",  name: "Varennes St Sauveur",  ca2024: 306808,  commercialId: "laurent-severine" },
      { id: "belmont-de-la-loire",  name: "Belmont De La Loire",  ca2024: 265071,  commercialId: "laurent-severine" },
      { id: "branges-bourg",        name: "Branges -Bourg",       ca2024: 239657,  commercialId: "laurent-severine" },
      { id: "vernet-la-varenne",    name: "Vernet La Varenne",    ca2024: 205100,  commercialId: "laurent-severine" },
      { id: "st-julien-la-vetre",   name: "St Julien La Vetre",   ca2024: 135653,  commercialId: "laurent-severine" },
      { id: "vollore-ville",        name: "Vollore-Ville",        ca2024: 133944,  commercialId: "laurent-severine" },
      { id: "vichy",                name: "Vichy",                ca2024: 120670,  commercialId: "laurent-severine" },
      { id: "issy-l-eveque",        name: "Issy L'eveque",        ca2024: 115010,  commercialId: "laurent-severine" },

      // MICHELET Yves
      { id: "monsols",              name: "Monsols",              ca2024: 479896,  commercialId: "michelet-yves" },
      { id: "gigny",                name: "Gigny",                ca2024: 324221,  commercialId: "michelet-yves" },
      { id: "bessenay",             name: "Bessenay",             ca2024: 306031,  commercialId: "michelet-yves" },
      { id: "propieres",            name: "Propieres",            ca2024: 285436,  commercialId: "michelet-yves" },
      { id: "legny-tarrets",        name: "Legny -Tarrets",       ca2024: 261950,  commercialId: "michelet-yves" },
      { id: "leymant-gare",         name: "Leyment -Gare",        ca2024: 236777,  commercialId: "michelet-yves" },
      { id: "porte-pier-dor-ecla",  name: "Porte Pier.Dor -Ecla", ca2024: 230494,  commercialId: "michelet-yves" },
      { id: "montanay-poype",       name: "Montanay -Poype",      ca2024: 195548,  commercialId: "michelet-yves" },
      { id: "villeurbanne-blum",    name: "Villeurbanne -Blum",   ca2024: 194895,  commercialId: "michelet-yves" },
      { id: "nivigne-et-suran",     name: "Nivigne-Et-Suran",     ca2024: 169848,  commercialId: "michelet-yves" },

      // AYDOGAN Nevin
      { id: "st-sorlin-d-arves",    name: "St Sorlin D'arves",    ca2024: 882204,  commercialId: "aydogan-nevin" },
      { id: "virieu-lamartine",     name: "Virieu -Lamartine",    ca2024: 661928,  commercialId: "aydogan-nevin" },
      { id: "proxi-auris-en-oisans",name: "Proxi Auris En Oisans",ca2024: 632066,  commercialId: "aydogan-nevin" },
      { id: "courchevel-1550",      name: "Courchevel 1550",      ca2024: 548632,  commercialId: "aydogan-nevin" },
      { id: "le-bourget-du-lac",    name: "Le Bourget Du Lac",    ca2024: 431544,  commercialId: "aydogan-nevin" },
      { id: "macot-la-plagne",      name: "Macot La Plagne",      ca2024: 403322,  commercialId: "aydogan-nevin" },
      { id: "lepin-le-lac-gare",    name: "Lepin-Le-Lac -Gare",   ca2024: 369333,  commercialId: "aydogan-nevin" },
      { id: "areches",              name: "Areches",              ca2024: 366692,  commercialId: "aydogan-nevin" },
      { id: "monestier-clermont",   name: "Monestier Clermont",   ca2024: 319730,  commercialId: "aydogan-nevin" },
      { id: "proxi-scionzier",      name: "Proxi Scionzier",      ca2024: 318598,  commercialId: "aydogan-nevin" },

      // VERNAY Benoit
      { id: "vals-les-bains",          name: "Vals Les Bains",                     ca2024: 759854,  commercialId: "vernay-benoit" },
      { id: "proxi-langogne-capucins", name: "Proxi Super Langogne Capucins",      ca2024: 554404,  commercialId: "vernay-benoit" },
      { id: "st-fortunat",             name: "St Fortunat",                        ca2024: 499207,  commercialId: "vernay-benoit" },
      { id: "8-a-huit-chadrac",        name: "8 √† Huit Chadrac",                   ca2024: 416296,  commercialId: "vernay-benoit" },
      { id: "le-cheylard",             name: "Le Cheylard",                        ca2024: 398914,  commercialId: "vernay-benoit" },
      { id: "espaly-st-marcel",        name: "Espaly St Marcel",                   ca2024: 364105,  commercialId: "vernay-benoit" },
      { id: "colombier-le-jeune",      name: "Colombier-Le-Jeune",                 ca2024: 353985,  commercialId: "vernay-benoit" },
      { id: "langeac-lafayette",       name: "Langeac -Lafayette",                 ca2024: 280621,  commercialId: "vernay-benoit" },
      { id: "allanche",                name: "Allanche",                           ca2024: 213408,  commercialId: "vernay-benoit" },
      { id: "saint-mamet-la-salvetas", name: "Saint mamet la salvetas",            ca2024: 317235,  commercialId: "vernay-benoit" }
    ];

    const WAVES = [
      { id: "wave1", label: "Vague 1" },
      { id: "wave2", label: "Vague 2" },
      { id: "wave3", label: "Vague 3" },
      { id: "wave4", label: "Vague 4" },
      { id: "wave5", label: "Vague 5" },
      { id: "wave6", label: "Vague 6" }
    ];
    const SEASONS = ["Printemps", "√ât√©", "Automne", "Hiver"];
    const WAVE_STATUSES = ["Non concern√©", "√Ä faire", "En cours", "Engag√©", "Refus√©"];

    /********* LOCAL STORAGE *********/
    const STORAGE_KEY = "mini-crm-fl-v4";
    function loadState() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return {};
        return JSON.parse(raw);
      } catch (e) { return {}; }
    }
    function saveState() {
      try { localStorage.setItem(STORAGE_KEY, JSON.stringify(STATE)); } catch (e) {}
    }

    // state par magasin
    let STATE = loadState();
    function getStoreState(id) {
      if (!STATE[id]) {
        STATE[id] = { seasons: [], waves: {}, buysFL: "", buysEng: "", notesFL: "", notesEng: "" };
      }
      return STATE[id];
    }

    /********* VARIABLES UI *********/
    const root = document.getElementById("root");
    let currentUser = null;
    let currentCommercialFilter = null;
    let currentTab = "list";
    let currentStoreId = null;
    let currentSearch = "";

    function formatNumber(n) {
      if (n == null) return "-";
      return n.toLocaleString("fr-FR");
    }

    function getUserStores(user) {
      if (!user) return [];
      if (user.role === "admin") {
        if (currentCommercialFilter) return STORES.filter(s => s.commercialId === currentCommercialFilter);
        return STORES;
      }
      return STORES.filter(s => s.commercialId === user.id);
    }

    function computeKpis(user) {
      const stores = getUserStores(user);
      const totalStores = stores.length;
      const totalCA = stores.reduce((sum, s) => sum + (s.ca2024 || 0), 0);
      let engagedStores = 0;
      let totalEngagements = 0;
      stores.forEach(s => {
        const st = getStoreState(s.id);
        let hasEng = false;
        WAVES.forEach(w => {
          if (st.waves[w.id] === "Engag√©") {
            hasEng = true;
            totalEngagements++;
          }
        });
        if (hasEng) engagedStores++;
      });
      const engagedRate = totalStores ? Math.round((engagedStores / totalStores) * 100) : 0;
      const avgEngagements = totalStores ? (totalEngagements / totalStores).toFixed(1) : "0.0";
      const avgCA = totalStores ? Math.round(totalCA / totalStores) : 0;
      return { totalStores, totalCA, engagedStores, engagedRate, avgEngagements, avgCA };
    }

    function computeCommercialSummaries() {
      return USERS.commerciaux.map(c => {
        const stores = STORES.filter(s => s.commercialId === c.id);
        const totalStores = stores.length;
        const totalCA = stores.reduce((sum, s) => sum + (s.ca2024 || 0), 0);
        let engagedStores = 0;
        let totalEngagements = 0;
        stores.forEach(s => {
          const st = getStoreState(s.id);
          let hasEng = false;
          WAVES.forEach(w => {
            if (st.waves[w.id] === "Engag√©") {
              hasEng = true;
              totalEngagements++;
            }
          });
          if (hasEng) engagedStores++;
        });
        const engagedRate = totalStores ? Math.round((engagedStores / totalStores) * 100) : 0;
        const avgEngagements = totalStores ? (totalEngagements / totalStores).toFixed(1) : "0.0";
        return { name: c.name, totalStores, totalCA, engagedStores, engagedRate, avgEngagements };
      });
    }

    /********* LOGIN *********/
    function renderLogin() {
      root.innerHTML = "";
      const wrap = document.createElement("div");
      wrap.className = "app-shell";

      const card = document.createElement("div");
      card.className = "card login-card";
      card.innerHTML = `
        <h1><span class="logo-dot"></span> Mini CRM Fruits & L√©gumes</h1>
        <div class="subtext">Connexion commercial ou admin (Marie-Charlotte / Xavier).</div>
        <div class="field" style="margin-top:16px;">
          <label>Type de profil</label>
          <select id="roleSelect">
            <option value="commercial">Commercial</option>
            <option value="admin">Admin</option>
          </select>
        </div>
        <div class="field">
          <label>Utilisateur</label>
          <select id="userSelect"></select>
        </div>
        <button id="loginBtn">Entrer dans le CRM</button>
        <div class="subtext" style="margin-top:8px;">Les donn√©es sont sauvegard√©es sur cet ordinateur (localStorage).</div>
      `;

      wrap.appendChild(card);
      root.appendChild(wrap);

      const roleSelect = card.querySelector("#roleSelect");
      const userSelect = card.querySelector("#userSelect");

      function refreshUserOptions() {
        const role = roleSelect.value;
        userSelect.innerHTML = "";
        const list = role === "admin" ? USERS.admins : USERS.commerciaux;
        list.forEach(u => {
          const opt = document.createElement("option");
          opt.value = u.id;
          opt.textContent = u.name;
          userSelect.appendChild(opt);
        });
      }
      roleSelect.addEventListener("change", refreshUserOptions);
      refreshUserOptions();

      card.querySelector("#loginBtn").addEventListener("click", () => {
        const role = roleSelect.value;
        const id = userSelect.value;
        if (!id) return;
        if (role === "admin") {
          currentUser = { ...USERS.admins.find(a => a.id === id) };
        } else {
          currentUser = { ...USERS.commerciaux.find(c => c.id === id), role: "commercial" };
        }
        currentCommercialFilter = null;
        currentTab = "list";
        currentStoreId = null;
        currentSearch = "";
        renderApp();
      });
    }

    /********* APP PRINCIPALE *********/
    function renderApp() {
      root.innerHTML = "";
      const shell = document.createElement("div");
      shell.className = "app-shell";

      // Sidebar
      const sidebar = document.createElement("div");
      sidebar.className = "sidebar card";
      sidebar.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:8px;">
          <div>
            <div style="font-size:13px;color:var(--muted);opacity:.85;">Connect√© en tant que</div>
            <div style="font-size:15px;font-weight:600;">${currentUser.name}</div>
            <div style="font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:.08em;opacity:.8;">
              ${currentUser.role === "admin" ? "Admin ¬∑ vue globale" : "Commercial ¬∑ portefeuille magasins"}
            </div>
          </div>
          <button class="secondary" id="logoutBtn">Quitter</button>
        </div>
        <div style="margin-top:10px;display:flex;gap:6px;flex-wrap:wrap;">
          <span class="chip">Fruits & L√©gumes</span>
          <span class="chip green">Campagnes engagement</span>
        </div>
      `;
      const listWrap = document.createElement("div");
      listWrap.className = "list";

      const commList =
        currentUser.role === "admin"
          ? USERS.commerciaux
          : USERS.commerciaux.filter(c => c.id === currentUser.id);

      const storesAll = getUserStores(currentUser);
      const byCommercial = {};
      storesAll.forEach(s => {
        byCommercial[s.commercialId] = (byCommercial[s.commercialId] || 0) + 1;
      });

      commList.forEach(c => {
        const count = byCommercial[c.id] || 0;
        const row = document.createElement("div");
        row.className = "commercial-row";
        const isActive =
          (currentUser.role === "commercial" && currentUser.id === c.id) ||
          (currentUser.role === "admin" && currentCommercialFilter === c.id) ||
          (currentUser.role === "admin" && !currentCommercialFilter && commList[0].id === c.id);
        if (isActive) row.classList.add("active");
        row.innerHTML = `
          <div>
            <div class="commercial-name">${c.name}</div>
            <div class="commercial-meta">${count} magasin(s)</div>
          </div>
          <span class="status-pill">Portefeuille</span>
        `;
        row.addEventListener("click", () => {
          if (currentUser.role === "admin") {
            currentCommercialFilter = c.id;
            currentStoreId = null;
            currentTab = "list";
            currentSearch = "";
            renderApp();
          }
        });
        listWrap.appendChild(row);
      });
      sidebar.appendChild(listWrap);

      // Main
      const main = document.createElement("div");
      main.className = "main";

      const kpiCard = document.createElement("div");
      kpiCard.className = "card";
      const kpis = computeKpis(currentUser);
      kpiCard.innerHTML = `
        <h1><span class="logo-dot"></span> Vue d'ensemble ${currentUser.role === "admin" ? "r√©seau" : "commerciale"}</h1>
        <div class="subtext">Page d'accueil : CA global, CA moyen par magasin et dynamique d'engagement.</div>
        <div class="kpi-row">
          <div class="kpi-card">
            <div class="kpi-label">Magasins en suivi</div>
            <div class="kpi-value">${kpis.totalStores}</div>
            <div class="kpi-sub">dans le portefeuille actuel</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-label">CA 2024 total</div>
            <div class="kpi-value">${formatNumber(kpis.totalCA)} ‚Ç¨</div>
            <div class="kpi-sub">somme de tous les magasins</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-label">CA moyen / magasin</div>
            <div class="kpi-value">${formatNumber(kpis.avgCA)} ‚Ç¨</div>
            <div class="kpi-sub">moyenne par point de vente</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-label">Magasins engag√©s (‚â•1 vague)</div>
            <div class="kpi-value">${kpis.engagedStores}</div>
            <div class="kpi-sub">${kpis.engagedRate}% du portefeuille</div>
          </div>
        </div>
      `;
      main.appendChild(kpiCard);

      if (currentUser.role === "admin") {
        const synth = document.createElement("div");
        synth.className = "card";
        const summaries = computeCommercialSummaries();
        synth.innerHTML = `
          <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;">
            <div>
              <div style="font-size:13px;font-weight:600;">Synth√®se r√©seau par commercial</div>
              <div class="subtext">Comparatif des CA et taux d'engagement pour voir qui a le plus avanc√©.</div>
            </div>
          </div>
          <table>
            <thead>
              <tr>
                <th>Commercial</th>
                <th>Magasins</th>
                <th>CA 2024</th>
                <th>Mag. engag√©s</th>
                <th>Taux d'engagement</th>
                <th>Vagues moy. / mag.</th>
              </tr>
            </thead>
            <tbody>
              ${summaries.map(s => `
                <tr>
                  <td>${s.name}</td>
                  <td>${s.totalStores}</td>
                  <td>${formatNumber(s.totalCA)} ‚Ç¨</td>
                  <td>${s.engagedStores}</td>
                  <td>${s.engagedRate} %</td>
                  <td>${s.avgEngagements}</td>
                </tr>
              `).join("")}
            </tbody>
          </table>
          <div class="bar-chart">
            ${summaries.map(s => `
              <div class="bar-row">
                <div class="bar-label">${s.name}</div>
                <div class="bar-bg"><div class="bar-fill" style="width:${s.engagedRate}%;"></div></div>
                <div class="bar-value">${s.engagedRate}%</div>
              </div>
            `).join("")}
          </div>
        `;
        main.appendChild(synth);
      }

      const mainCard = document.createElement("div");
      mainCard.className = "card";

      const stores = getUserStores(currentUser).slice().sort((a, b) => b.ca2024 - a.ca2024);
      if (!currentStoreId && stores.length) currentStoreId = stores[0].id;
      const currentStore = stores.find(s => s.id === currentStoreId) || stores[0];

      const header = document.createElement("div");
      header.style.display = "flex";
      header.style.justifyContent = "space-between";
      header.style.alignItems = "center";
      header.style.gap = "12px";
      header.innerHTML = `
        <div>
          <div style="font-size:13px;font-weight:600;">Portefeuille magasins</div>
          <div class="subtext">Onglets <strong>Magasins</strong>, <strong>Fruits & L√©gumes</strong> et <strong>Engagement</strong>.</div>
        </div>
        <div class="tabs">
          <button class="tab-btn ${currentTab === "list" ? "active" : ""}" data-tab="list">Magasins</button>
          <button class="tab-btn ${currentTab === "fl" ? "active" : ""}" data-tab="fl">Fruits & L√©gumes</button>
          <button class="tab-btn ${currentTab === "eng" ? "active" : ""}" data-tab="eng">Engagement</button>
        </div>
      `;
      mainCard.appendChild(header);

      const content = document.createElement("div");
      content.className = "two-columns";

      if (stores.length === 0) {
        content.innerHTML = '<div class="subtext">Aucun magasin dans ce portefeuille.</div>';
      } else {
        if (currentTab === "list") {
          renderStoresTab(content, stores, currentStore);
        } else if (currentTab === "fl") {
          renderFruitsLegumesTab(content, stores, currentStore);
        } else {
          renderEngagementTab(content, stores, currentStore);
        }
      }

      mainCard.appendChild(content);
      main.appendChild(mainCard);

      shell.appendChild(sidebar);
      shell.appendChild(main);
      root.appendChild(shell);

      const logoutBtn = sidebar.querySelector("#logoutBtn");
      if (logoutBtn) {
        logoutBtn.addEventListener("click", () => {
          currentUser = null;
          currentCommercialFilter = null;
          currentStoreId = null;
          currentTab = "list";
          currentSearch = "";
          renderLogin();
        });
      }
      mainCard.querySelectorAll(".tab-btn").forEach(btn => {
        btn.addEventListener("click", () => {
          currentTab = btn.dataset.tab;
          renderApp();
        });
      });
    }

    /********* ONGLET 1 : MAGASINS *********/
    function renderStoresTab(container, stores, currentStore) {
      const left = document.createElement("div");
      const right = document.createElement("div");

      const filtered = stores.filter(s =>
        s.name.toLowerCase().includes((currentSearch || "").toLowerCase())
      );

      left.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;">
          <div>
            <div style="font-size:13px;font-weight:600;">Magasins ¬∑ Vue CA</div>
            <div class="subtext">Recherche par nom + CA 2024.</div>
          </div>
        </div>
        <div class="search-row">
          <input class="search-input" id="searchInput" placeholder="Rechercher un magasin..." value="${currentSearch || ""}" />
        </div>
        <table>
          <thead>
            <tr>
              <th>Magasin</th>
              <th>CA 2024</th>
            </tr>
          </thead>
          <tbody>
            ${filtered.map(s => `
              <tr data-id="${s.id}">
                <td>${s.name}</td>
                <td>${formatNumber(s.ca2024)} ‚Ç¨</td>
              </tr>
            `).join("")}
          </tbody>
        </table>
      `;

      const input = left.querySelector("#searchInput");
      input.addEventListener("input", () => {
        currentSearch = input.value;
        renderApp();
      });

      left.querySelectorAll("tbody tr").forEach(tr => {
        tr.addEventListener("click", () => {
          currentStoreId = tr.dataset.id;
          renderApp();
        });
      });

      if (currentStore) {
        const st = getStoreState(currentStore.id);
        const engagedCount = WAVES.filter(w => st.waves[w.id] === "Engag√©").length;
        const seasonsActives = st.seasons.length;
        right.innerHTML = `
          <div style="font-size:13px;font-weight:600;">${currentStore.name}</div>
          <div class="subtext">R√©sum√© magasin : CA, commandes et niveau d'engagement.</div>
          <div style="margin-top:10px;display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:8px;">
            <div class="kpi-card" style="padding:8px 10px;">
              <div class="kpi-label">CA 2024</div>
              <div class="kpi-value" style="font-size:15px;">${formatNumber(currentStore.ca2024)} ‚Ç¨</div>
            </div>
            <div class="kpi-card" style="padding:8px 10px;">
              <div class="kpi-label">Vagues engag√©es</div>
              <div class="kpi-value" style="font-size:15px;">${engagedCount}</div>
            </div>
            <div class="kpi-card" style="padding:8px 10px;">
              <div class="kpi-label">Saisons actives</div>
              <div class="kpi-value" style="font-size:15px;">${seasonsActives}</div>
            </div>
          </div>
          <div style="margin-top:10px;font-size:12px;">
            <div style="font-weight:600;margin-bottom:4px;">Commande F&L ?</div>
            <div>${st.buysFL || '<span class="subtext">Non renseign√©</span>'}</div>
          </div>
          <div style="margin-top:6px;font-size:12px;">
            <div style="font-weight:600;margin-bottom:4px;">Commande engagement ?</div>
            <div>${st.buysEng || '<span class="subtext">Non renseign√©</span>'}</div>
          </div>
        `;
      } else {
        right.innerHTML = '<div class="subtext">S√©lectionne un magasin dans la liste.</div>';
      }

      container.appendChild(left);
      container.appendChild(right);
    }

    /********* ONGLET 2 : FRUITS & L√âGUMES *********/
    function renderFruitsLegumesTab(container, stores, currentStore) {
      const left = document.createElement("div");
      const right = document.createElement("div");

      left.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;">
          <div>
            <div style="font-size:13px;font-weight:600;">Magasins ¬∑ Fruits & L√©gumes</div>
            <div class="subtext">Information "commande F&L" et s√©lection du magasin.</div>
          </div>
        </div>
        <table>
          <thead>
            <tr>
              <th>Magasin</th>
              <th>Commande F&L ?</th>
            </tr>
          </thead>
          <tbody>
            ${stores.map(s => {
              const st = getStoreState(s.id);
              const buys = st.buysFL || "";
              return `
                <tr data-id="${s.id}">
                  <td>${s.name}</td>
                  <td>
                    <select data-buys-fl="${s.id}">
                      <option value="">NC</option>
                      <option value="Oui" ${buys === "Oui" ? "selected" : ""}>Oui</option>
                      <option value="Non" ${buys === "Non" ? "selected" : ""}>Non</option>
                    </select>
                  </td>
                </tr>
              `;
            }).join("")}
          </tbody>
        </table>
      `;

      left.querySelectorAll("tbody tr").forEach(tr => {
        tr.addEventListener("click", e => {
          if (e.target.tagName.toLowerCase() === "select") return;
          currentStoreId = tr.dataset.id;
          renderApp();
        });
      });
      left.querySelectorAll("select[data-buys-fl]").forEach(sel => {
        sel.addEventListener("change", () => {
          const id = sel.dataset.buysFl;
          const st = getStoreState(id);
          st.buysFL = sel.value;
          saveState();
        });
      });

      if (currentStore) {
        const st = getStoreState(currentStore.id);
        right.innerHTML = `
          <div style="font-size:13px;font-weight:600;">${currentStore.name}</div>
          <div class="subtext">Saisons travaill√©es & compte-rendu Fruits & L√©gumes.</div>
          <div style="margin-top:10px;">
            <div style="font-size:12px;font-weight:600;margin-bottom:4px;">Saisons Fruits & L√©gumes</div>
            <div class="seasons">
              ${SEASONS.map(season => {
                const active = st.seasons.includes(season);
                return `<button type="button" class="season-pill ${active ? "active" : ""}" data-season="${season}">${season}</button>`;
              }).join("")}
            </div>
          </div>
          <div style="margin-top:12px;">
            <div style="font-size:12px;font-weight:600;margin-bottom:4px;">Notes / actions Fruits & L√©gumes</div>
            <textarea rows="5" id="notesFL">${st.notesFL || ""}</textarea>
          </div>
        `;

        right.querySelectorAll(".season-pill").forEach(btn => {
          btn.addEventListener("click", () => {
            const season = btn.dataset.season;
            const st2 = getStoreState(currentStore.id);
            const idx = st2.seasons.indexOf(season);
            if (idx >= 0) st2.seasons.splice(idx, 1); else st2.seasons.push(season);
            saveState();
            renderApp();
          });
        });
        const ta = right.querySelector("#notesFL");
        ta.addEventListener("input", () => {
          const st2 = getStoreState(currentStore.id);
          st2.notesFL = ta.value;
          saveState();
        });
      } else {
        right.innerHTML = '<div class="subtext">S√©lectionne un magasin dans la liste.</div>';
      }

      container.appendChild(left);
      container.appendChild(right);
    }

    /********* ONGLET 3 : ENGAGEMENT *********/
    function renderEngagementTab(container, stores, currentStore) {
      const left = document.createElement("div");
      const right = document.createElement("div");

      left.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;">
          <div>
            <div style="font-size:13px;font-weight:600;">Magasins ¬∑ Engagement</div>
            <div class="subtext">Suivi des 6 vagues d'engagement et "commande engagement".</div>
          </div>
        </div>
        <table>
          <thead>
            <tr>
              <th>Magasin</th>
              <th>Commande engagement ?</th>
              <th>Vagues engag√©es</th>
            </tr>
          </thead>
          <tbody>
            ${stores.map(s => {
              const st = getStoreState(s.id);
              const buys = st.buysEng || "";
              const engagedCount = WAVES.filter(w => st.waves[w.id] === "Engag√©").length;
              return `
                <tr data-id="${s.id}">
                  <td>${s.name}</td>
                  <td>
                    <select data-buys-eng="${s.id}">
                      <option value="">NC</option>
                      <option value="Oui" ${buys === "Oui" ? "selected" : ""}>Oui</option>
                      <option value="Non" ${buys === "Non" ? "selected" : ""}>Non</option>
                    </select>
                  </td>
                  <td>${engagedCount}</td>
                </tr>
              `;
            }).join("")}
          </tbody>
        </table>
      `;

      left.querySelectorAll("tbody tr").forEach(tr => {
        tr.addEventListener("click", e => {
          if (e.target.tagName.toLowerCase() === "select") return;
          currentStoreId = tr.dataset.id;
          renderApp();
        });
      });
      left.querySelectorAll("select[data-buys-eng]").forEach(sel => {
        sel.addEventListener("change", () => {
          const id = sel.dataset.buysEng;
          const st = getStoreState(id);
          st.buysEng = sel.value;
          saveState();
        });
      });

      if (currentStore) {
        const st = getStoreState(currentStore.id);
        right.innerHTML = `
          <div style="font-size:13px;font-weight:600;">${currentStore.name}</div>
          <div class="subtext">Suivi d√©taill√© des 6 vagues d'engagement + notes.</div>
          <div style="margin-top:10px;">
            <div style="font-size:12px;font-weight:600;margin-bottom:4px;">Vagues d'engagement</div>
            <div class="waves-grid">
              ${WAVES.map(w => {
                const val = st.waves[w.id] || "Non concern√©";
                return `
                  <div class="wave-card">
                    <div class="wave-title">${w.label}</div>
                    <select data-wave="${w.id}">
                      ${WAVE_STATUSES.map(stat => `<option value="${stat}" ${stat === val ? "selected" : ""}>${stat}</option>`).join("")}
                    </select>
                  </div>
                `;
              }).join("")}
            </div>
          </div>
          <div style="margin-top:12px;">
            <div style="font-size:12px;font-weight:600;margin-bottom:4px;">Notes / actions Engagement</div>
            <textarea rows="5" id="notesEng">${st.notesEng || ""}</textarea>
          </div>
        `;

        right.querySelectorAll("select[data-wave]").forEach(sel => {
          sel.addEventListener("change", () => {
            const waveId = sel.dataset.wave;
            const st2 = getStoreState(currentStore.id);
            st2.waves[waveId] = sel.value;
            saveState();
            renderApp();
          });
        });
        const ta = right.querySelector("#notesEng");
        ta.addEventListener("input", () => {
          const st2 = getStoreState(currentStore.id);
          st2.notesEng = ta.value;
          saveState();
        });
      } else {
        right.innerHTML = '<div class="subtext">S√©lectionne un magasin dans la liste.</div>';
      }

      container.appendChild(left);
      container.appendChild(right);
    }

    renderLogin();
  </script>
</body>
</html>
