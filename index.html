<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>CRM PROXI</title>

<style>
body {
  margin:0;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
  background:#0b1120;
  color:#f9fafb;
}
.app-shell {
  max-width:1400px;
  margin:auto;
  padding:16px;
}
.card {
  background:#111827;
  border-radius:16px;
  padding:16px;
  margin-bottom:12px;
}
.tabs button {
  margin-right:6px;
}
table {
  width:100%;
  border-collapse:collapse;
}
td, th {
  padding:6px;
  border-bottom:1px solid #374151;
}
input, select, textarea {
  width:100%;
  background:#0f172a;
  color:white;
  border:1px solid #374151;
  border-radius:8px;
  padding:6px;
}
</style>
</head>

<body>
<div id="root"></div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
/* ================= SUPABASE ================= */
const SUPABASE_URL = "https://sytpnqayyyjdjhojafyi.supabase.co";
const SUPABASE_KEY = "sb_publishable_5ernJ3tbCW3XnAdx983E8A_ASPSKBVx";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* ================= DATA ================= */
const SEASONS = ["Printemps","Été","Automne","Hiver"];

const STORES = [
  { id:"poulx", name:"Poulx" },
  { id:"moussac", name:"Moussac" },
  { id:"vercheny", name:"Vercheny" }
];

/* ================= STATE ================= */
let STATE = {};
let currentStoreId = null;

/* ================= LOAD ================= */
async function loadState() {
  const { data } = await sb.from("store_state").select("*");
  STATE = {};
  (data || []).forEach(r => {
    STATE[r.id] = {
      flBySeason: r.fl_by_season ? JSON.parse(r.fl_by_season) : {}
    };
  });
}

/* ================= HELPERS ================= */
function getStoreState(id) {
  if (!STATE[id]) {
    STATE[id] = {
      flBySeason: {
        "Printemps": { ordered:"", amount:"", plan:"" },
        "Été": { ordered:"", amount:"", plan:"" },
        "Automne": { ordered:"", amount:"", plan:"" },
        "Hiver": { ordered:"", amount:"", plan:"" }
      }
    };
  }
  return STATE[id];
}

async function saveStore(id) {
  const st = getStoreState(id);
  await sb.from("store_state").upsert({
    id,
    fl_by_season: JSON.stringify(st.flBySeason)
  });
}

/* ================= UI ================= */
function render() {
  const root = document.getElementById("root");
  root.innerHTML = "";

  const left = document.createElement("div");
  const right = document.createElement("div");

  left.className = "card";
  right.className = "card";

  /* LISTE MAGASINS */
  left.innerHTML = `
    <h3>Magasins</h3>
    <table>
      ${STORES.map(s => `
        <tr data-id="${s.id}">
          <td>${s.name}</td>
        </tr>
      `).join("")}
    </table>
  `;

  left.querySelectorAll("tr").forEach(tr => {
    tr.onclick = () => {
      currentStoreId = tr.dataset.id;
      render();
    };
  });

  /* DETAIL F&L */
  if (currentStoreId) {
    const st = getStoreState(currentStoreId);

    right.innerHTML = `
      <h3>Fruits & Légumes – ${currentStoreId}</h3>
      ${SEASONS.map(season => {
        const d = st.flBySeason[season];
        return `
          <div class="card">
            <strong>${season}</strong><br><br>

            Commande ?
            <select data-o="${season}">
              <option value="">NC</option>
              <option value="Oui" ${d.ordered==="Oui"?"selected":""}>Oui</option>
              <option value="Non" ${d.ordered==="Non"?"selected":""}>Non</option>
            </select><br><br>

            Montant (€)
            <input type="number" data-a="${season}" value="${d.amount||""}"><br><br>

            Plan d’action
            <textarea data-p="${season}">${d.plan||""}</textarea>
          </div>
        `;
      }).join("")}
    `;

    right.querySelectorAll("select[data-o]").forEach(el => {
      el.onchange = () => {
        const s = el.dataset.o;
        st.flBySeason[s].ordered = el.value;
        saveStore(currentStoreId);
      };
    });

    right.querySelectorAll("input[data-a]").forEach(el => {
      el.oninput = () => {
        const s = el.dataset.a;
        st.flBySeason[s].amount = el.value;
        saveStore(currentStoreId);
      };
    });

    right.querySelectorAll("textarea[data-p]").forEach(el => {
      el.oninput = () => {
        const s = el.dataset.p;
        st.flBySeason[s].plan = el.value;
        saveStore(currentStoreId);
      };
    });

  } else {
    right.innerHTML = "<p>Sélectionne un magasin</p>";
  }

  root.appendChild(left);
  root.appendChild(right);
}

/* ================= INIT ================= */
(async () => {
  await loadState();
  render();
})();
</script>
</body>
</html>
